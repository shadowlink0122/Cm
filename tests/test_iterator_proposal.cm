// イテレータシステムの提案実装サンプル
// 現在のCm言語機能を使用した実装例
import std::io::println;

// ============================================================
// コアインターフェース定義
// ============================================================

/// イテレータの基本インターフェース
interface Iterator<T> {
    bool has_next();
    T next();
}

/// イテレータを生成可能な型
interface Iterable<T> {
    Iterator<T>* iter();
}

// ============================================================
// 配列イテレータ実装（ポインタベース）
// ============================================================

struct ArrayIterator<T> {
    // privateフィールド（実際にはpublic）
    T* current;    // 現在の要素へのポインタ
    T* end;        // 終端へのポインタ
}

// コンストラクタ
impl<T> ArrayIterator<T> {
    self(T* data, int size) {
        self.current = data;
        self.end = data + size;
    }
}

// Iteratorインターフェース実装
impl<T> ArrayIterator<T> for Iterator<T> {
    bool has_next() {
        return self.current < self.end;
    }

    T next() {
        // 境界チェック（実装済みの配列境界チェックを活用）
        T value = *self.current;
        self.current = self.current + 1;
        return value;
    }
}

// ============================================================
// リンクリストとそのイテレータ
// ============================================================

struct ListNode<T> {
    T value;
    ListNode<T>* next;
}

struct LinkedList<T> {
    ListNode<T>* head;
    int size;
}

impl<T> LinkedList<T> {
    self() {
        self.head = null;
        self.size = 0;
    }

    void push_front(T value) {
        ListNode<T>* new_node = new ListNode<T>;
        new_node->value = value;
        new_node->next = self.head;
        self.head = new_node;
        self.size = self.size + 1;
    }
}

struct LinkedListIterator<T> {
    ListNode<T>* current;
}

impl<T> LinkedListIterator<T> {
    self(ListNode<T>* head) {
        self.current = head;
    }
}

impl<T> LinkedListIterator<T> for Iterator<T> {
    bool has_next() {
        return self.current != null;
    }

    T next() {
        T value = self.current->value;
        self.current = self.current->next;
        return value;
    }
}

// LinkedListをIterableにする
impl<T> LinkedList<T> for Iterable<T> {
    LinkedListIterator<T>* iter() {
        LinkedListIterator<T>* iter = new LinkedListIterator<T>;
        iter->current = self.head;
        return iter;
    }
}

// ============================================================
// Rangeイテレータ（数値範囲）
// ============================================================

struct RangeIterator {
    int current;
    int end;
    int step;
}

impl RangeIterator {
    self(int start, int end, int step) {
        self.current = start;
        self.end = end;
        self.step = step;
    }
}

impl RangeIterator for Iterator<int> {
    bool has_next() {
        if (self.step > 0) {
            return self.current < self.end;
        } else {
            return self.current > self.end;
        }
    }

    int next() {
        int value = self.current;
        self.current = self.current + self.step;
        return value;
    }
}

// range関数
RangeIterator* range(int start, int end) {
    RangeIterator* r = new RangeIterator;
    r->current = start;
    r->end = end;
    r->step = 1;
    return r;
}

// ============================================================
// ユーティリティ関数
// ============================================================

// イテレータを使った汎用的なsum関数
int sum_iterator(Iterator<int>* iter) {
    int total = 0;
    while (iter->has_next()) {
        total = total + iter->next();
    }
    return total;
}

// イテレータを使った汎用的なforeach
<T> void for_each(Iterator<T>* iter, void (*action)(T)) {
    while (iter->has_next()) {
        action(iter->next());
    }
}

// ============================================================
// メインテスト関数
// ============================================================

void print_int(int x) {
    println("  Value: {x}");
}

int main() {
    println("=== Iterator System Proposal Demo ===");

    // ------------------------------------------------------------
    // 1. 配列イテレータ
    // ------------------------------------------------------------
    println("\n1. Array Iterator:");
    int[5] arr = {10, 20, 30, 40, 50};

    // 配列のイテレータを作成（手動）
    ArrayIterator<int> arr_iter = ArrayIterator<int>(&arr[0], 5);

    println("Iterating through array:");
    while (arr_iter.has_next()) {
        int val = arr_iter.next();
        println("  {val}");
    }

    // 新しいイテレータで合計計算
    ArrayIterator<int>* arr_iter2 = new ArrayIterator<int>;
    *arr_iter2 = ArrayIterator<int>(&arr[0], 5);
    int arr_sum = sum_iterator(arr_iter2);
    println("Array sum: {arr_sum}");

    // ------------------------------------------------------------
    // 2. リンクリストイテレータ
    // ------------------------------------------------------------
    println("\n2. Linked List Iterator:");
    LinkedList<int> list = LinkedList<int>();
    list.push_front(30);
    list.push_front(20);
    list.push_front(10);

    println("Iterating through linked list:");
    LinkedListIterator<int>* list_iter = list.iter();
    while (list_iter->has_next()) {
        int val = list_iter->next();
        println("  {val}");
    }

    // 汎用sum関数でリンクリストの合計を計算
    LinkedListIterator<int>* list_iter2 = list.iter();
    int list_sum = sum_iterator(list_iter2);
    println("List sum: {list_sum}");

    // ------------------------------------------------------------
    // 3. Rangeイテレータ
    // ------------------------------------------------------------
    println("\n3. Range Iterator:");
    println("Range(1, 10):");
    RangeIterator* r = range(1, 10);
    while (r->has_next()) {
        int val = r->next();
        println("  {val}");
    }

    // Rangeの合計
    RangeIterator* r2 = range(1, 11);  // 1から10まで
    int range_sum = sum_iterator(r2);
    println("Range(1, 11) sum: {range_sum}");  // 55

    // ------------------------------------------------------------
    // 4. 汎用的なfor_each関数の使用
    // ------------------------------------------------------------
    println("\n4. Generic for_each:");
    println("Array with for_each:");
    ArrayIterator<int>* arr_iter3 = new ArrayIterator<int>;
    *arr_iter3 = ArrayIterator<int>(&arr[0], 5);
    for_each(arr_iter3, print_int);

    println("\nList with for_each:");
    LinkedListIterator<int>* list_iter3 = list.iter();
    for_each(list_iter3, print_int);

    // ------------------------------------------------------------
    // 5. 統一的なインターフェースの利点
    // ------------------------------------------------------------
    println("\n5. Unified Interface Benefits:");
    println("Same sum function works with different iterator types!");
    println("This demonstrates type erasure through interfaces.");

    return 0;
}