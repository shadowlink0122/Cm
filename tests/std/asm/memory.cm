// tests/std/asm/memory.cm
// std::asm 直接メモリ操作テスト

import std::io::println;
import std::asm::{asm_ptr, asm_ptr_val, asm_ptr_ret, is_x86, is_arm64};

int main() {
    println("=== asm/memory test ===");
    
    // ============================================================
    // 直接asm命令でのストア
    // ============================================================
    println("--- asm store ---");
    
    int value = 0;
    
    if (is_x86()) {
        // x86: movl %1, (%0)
        asm_ptr_val("movl %1, (%0)", &value, 42);
        println("x86 store: ok");
    } else if (is_arm64()) {
        // ARM64: str %1, [%0]
        asm_ptr_val("str %1, [%0]", &value, 42);
        println("arm64 store: ok");
    } else {
        println("store: skip");
    }
    println(value);
    
    // ============================================================
    // 直接asm命令でのロード
    // ============================================================
    println("--- asm load ---");
    
    int source = 100;
    int loaded = 0;
    
    if (is_x86()) {
        // x86: movl (%0), %0
        loaded = asm_ptr_ret("movl (%0), %0", &source);
        println("x86 load: ok");
    } else if (is_arm64()) {
        // ARM64: ldr %0, [%0]
        loaded = asm_ptr_ret("ldr %0, [%0]", &source);
        println("arm64 load: ok");
    } else {
        println("load: skip");
    }
    println(loaded);
    
    // ============================================================
    // インクリメント/デクリメント
    // ============================================================
    println("--- asm modify ---");
    
    int counter = 10;
    
    if (is_x86()) {
        asm_ptr("incl (%0)", &counter);
        println("x86 inc: ok");
        println(counter);  // 11
        
        asm_ptr("decl (%0)", &counter);
        println("x86 dec: ok");
        println(counter);  // 10
    } else {
        println("modify: skip");
        println(counter);
        println(counter);
    }
    
    println("=== memory complete ===");
    return 0;
}
