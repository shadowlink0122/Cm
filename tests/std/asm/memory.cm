// tests/std/asm/memory.cm
// std::asm メモリ操作テスト

import std::io::println;
import std::asm::{asm_load_i32, asm_store_i32, atomic_load_i32, atomic_store_i32, cas_i32};

int main() {
    println("=== asm/memory test ===");
    
    // ============================================================
    // 基本的なロード/ストア
    // ============================================================
    println("--- load/store ---");
    
    int value = 100;
    int loaded = asm_load_i32(&value);
    println("load: ok");
    println(loaded);  // 100
    
    asm_store_i32(&value, 200);
    println("store: ok");
    println(value);   // 200
    
    // ============================================================
    // アトミックロード/ストア
    // ============================================================
    println("--- atomic ---");
    
    int atomic_val = 42;
    int atomic_loaded = atomic_load_i32(&atomic_val);
    println("atomic_load: ok");
    println(atomic_loaded);  // 42
    
    atomic_store_i32(&atomic_val, 99);
    println("atomic_store: ok");
    println(atomic_val);     // 99
    
    // ============================================================
    // Compare-And-Swap
    // ============================================================
    println("--- cas ---");
    
    int cas_val = 10;
    
    // CAS成功：expected == 現在値
    bool success1 = cas_i32(&cas_val, 10, 20);
    println("cas success:");
    println(success1);  // true
    println(cas_val);   // 20
    
    // CAS失敗：expected != 現在値
    bool success2 = cas_i32(&cas_val, 10, 30);
    println("cas fail:");
    println(success2);  // false
    println(cas_val);   // 20（変更なし）
    
    println("=== memory complete ===");
    return 0;
}
