// Result型のチェインとネストパターンテスト
// matchバインディングを具象型変数に代入して使用
import std::io::println;

// Result型を明示的に定義
enum Result<T, E> {
    Ok(T),
    Err(E)
}

// --- ヘルパー関数群 ---

// 安全な除算
Result<int, string> safe_divide(int a, int b) {
    if (b == 0) {
        return Result::Err("division by zero");
    }
    return Result::Ok(a / b);
}

// 範囲チェック（0〜max）
Result<int, string> check_range(int value, int max) {
    if (value < 0) {
        return Result::Err("negative value");
    }
    if (value > max) {
        return Result::Err("exceeds maximum");
    }
    return Result::Ok(value);
}

// 数字バリデーション（0〜9）
Result<int, string> parse_digit(int digit) {
    if (digit < 0) {
        return Result::Err("negative digit");
    }
    if (digit > 9) {
        return Result::Err("not a single digit");
    }
    return Result::Ok(digit);
}

int main() {
    println("=== Result Chain Test ===");

    // --- チェインテスト ---
    println("--- Chain Test ---");

    // 成功チェイン: 100 / 5 = 20, check_range(20, 50) = ok
    Result<int, string> r1 = safe_divide(100, 5);
    match (r1) {
        Result::Ok(v) => {
            int val = v;
            Result<int, string> r2 = check_range(val, 50);
            match (r2) {
                Result::Ok(v2) => {
                    int val2 = v2;
                    println("chain ok: {val2}");
                }
                Result::Err(e) => { println("range fail: {e}"); }
            }
        }
        Result::Err(e) => { println("divide fail: {e}"); }
    }

    // 失敗チェイン: 100 / 3 = 33, check_range(33, 10) = exceeds
    Result<int, string> r3 = safe_divide(100, 3);
    match (r3) {
        Result::Ok(v) => {
            int val = v;
            Result<int, string> r4 = check_range(val, 10);
            match (r4) {
                Result::Ok(v2) => {
                    int val2 = v2;
                    println("chain ok: {val2}");
                }
                Result::Err(e) => { println("range fail: {e}"); }
            }
        }
        Result::Err(e) => { println("divide fail: {e}"); }
    }

    // 除算失敗
    Result<int, string> r5 = safe_divide(100, 0);
    match (r5) {
        Result::Ok(v) => {
            int val = v;
            println("unexpected ok: {val}");
        }
        Result::Err(e) => { println("divide fail: {e}"); }
    }

    // --- 複数戻り値テスト ---
    println("--- Multiple Returns Test ---");
    int i = 0;
    while (i < 5) {
        int input = i * 3;
        Result<int, string> r = parse_digit(input);
        match (r) {
            Result::Ok(v) => {
                int val = v;
                println("digit({input}): {val}");
            }
            Result::Err(e) => { println("digit({input}): {e}"); }
        }
        i = i + 1;
    }

    // --- 集約テスト ---
    println("--- Accumulate Test ---");
    int sum = 0;
    int j = 1;
    while (j <= 4) {
        Result<int, string> r = safe_divide(100, j);
        match (r) {
            Result::Ok(v) => {
                int val = v;
                sum = sum + val;
            }
            Result::Err(e) => { println("skip: {e}"); }
        }
        j = j + 1;
    }
    // 100/1 + 100/2 + 100/3 + 100/4 = 100 + 50 + 33 + 25 = 208
    println("sum: {sum}");

    // --- 演算テスト ---
    println("--- Arithmetic Test ---");
    Result<int, string> ra = safe_divide(100, 4);
    match (ra) {
        Result::Ok(v) => {
            int val = v;
            int doubled = val * 2;
            int added = val + 10;
            println("val={val}, doubled={doubled}, added={added}");
        }
        Result::Err(e) => { println("err: {e}"); }
    }

    println("=== PASS ===");
    return 0;
}
