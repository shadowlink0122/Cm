//! platform: uefi
// Bug#12回帰テスト: ASM内ret命令を含む関数の正常呼出
// インライン展開されると、call命令が省略されreturn addressがスタックに存在しない
// 修正: ASM含む関数はインライン展開されないため、call→retが正常動作

export void context_switch(ulong old_rsp_ptr, ulong new_rsp) {
    // ret命令を含むASM関数
    __asm__(`
        movq ${r:old_rsp_ptr}, %r10;
        movq %rsp, (%r10);
        movq ${r:new_rsp}, %rsp;
        ret
    `);
}

ulong efi_main(void* image_handle, void* system_table) {
    void* ih = image_handle;
    void* st = system_table;

    ulong old_rsp = 0;
    ulong new_rsp = 0x80000;

    // ❌ 以前はインライン展開でret先が不在となりクラッシュ
    // ✅ 修正後はcallqで呼出されるためretが正常動作
    // 注意: このテストはコンパイルのみ検証（実行は環境依存）
    // context_switch(old_rsp, new_rsp);

    while (true) { __asm__("hlt"); }
    return 0;
}
