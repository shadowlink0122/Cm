// テスト: ポインタメンバーを通じたinterfaceメソッド呼び出し

import std::io::println;

use libc {
    void* malloc(ulong size);
    void free(void* ptr);
}

// ============================================================
// ノード構造体とインターフェース
// ============================================================
struct Node {
    int value;
    Node* next;
}

interface ValueOps {
    int get_value();
    void set_value(int v);
}

impl Node for ValueOps {
    int get_value() {
        return self.value;
    }
    
    void set_value(int v) {
        self.value = v;
    }
}

int main() {
    println("=== Pointer Member Interface Test ===");
    
    // ノード1を作成
    void* mem1 = malloc(sizeof(Node));
    Node* node1 = mem1 as Node*;
    node1->value = 10;
    node1->next = null as Node*;
    
    // ノード2を作成
    void* mem2 = malloc(sizeof(Node));
    Node* node2 = mem2 as Node*;
    node2->value = 20;
    node2->next = null as Node*;
    
    // ノード1からノード2へリンク
    node1->next = node2;
    
    // テスト1: 直接的なメソッド呼び出し
    println("\nTest 1: Direct method call on pointer");
    int v1 = node1->get_value();  // node1のメソッド呼び出し
    println("  node1->get_value() = {v1}");
    
    // テスト2: ポインタメンバー経由のメソッド呼び出し
    println("\nTest 2: Method call via pointer member");
    if (node1->next != null) {
        // node1->next はNode*型
        // これがinterfaceメソッドを呼び出せるか？
        int v2 = node1->next->get_value();  // ← これが動くか確認！
        println("  node1->next->get_value() = {v2}");
    }
    
    // テスト3: setメソッドでポインタメンバーを変更
    println("\nTest 3: Set value via pointer member method");
    if (node1->next != null) {
        node1->next->set_value(99);
        int v3 = node1->next->get_value();
        println("  After set_value(99): node1->next->get_value() = {v3}");
    }
    
    // クリーンアップ
    free(mem1);
    free(mem2);
    
    println("\n=== Done ===");
    return 0;
}
