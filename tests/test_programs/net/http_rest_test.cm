// http_rest_test.cm - HTTP REST API テスト (struct+impl)
// HttpClient + HttpServer（Cmサイド実装）による統合テスト
//
// テスト構成:
//   1. HttpServerをCm側でルーティング・レスポンス制御
//   2. HttpClientでGET/POST/PUT/DELETE
//   3. 404エラーハンドリング
//   4. 接続失敗テスト
//   5. 非同期並列GETリクエスト (thread + channel)

import std::io::println;
import std::http::*;
import std::thread::spawn;
import std::thread::spawn_with_arg;
import std::thread::join;
import std::thread::sleep_ms;
import std::sync::channel::create;
import std::sync::channel::send;
import std::sync::channel::recv;
import std::sync::channel::destroy;

// Cm側サーバスレッド: ルーティングとレスポンスをCmで制御
void* server_thread(void* arg) {
    HttpServer server;
    server.init(18300);
    server.listen();

    // 7リクエスト処理
    for (int i = 0; i < 7; i++) {
        HttpServerRequest req = server.accept();
        string method = req.method();
        string path = req.path();

        if (method == "GET" && path == "/api/hello") {
            req.respond(200, "{\"message\": \"Hello, World!\"}");
        } else if (method == "POST" && path == "/api/echo") {
            string body = req.body();
            req.respond(200, body);
        } else if (method == "PUT" && path == "/api/update") {
            req.respond(200, "{\"updated\": true}");
        } else if (method == "DELETE" && path == "/api/remove") {
            req.respond(200, "{\"deleted\": true}");
        } else {
            req.respond(404, "{\"reason\": \"Not Found\"}");
        }
    }

    server.close();
    return 0 as void*;
}

// 非同期GETワーカー (結果のステータスコードをチャネルに送信)
void* async_get_worker(void* ch_ptr) {
    long ch = ch_ptr as long;
    HttpClient client;
    client.init("127.0.0.1", 18300);
    HttpResponse resp = client.get("/api/hello");
    if (resp.is_ok == 1) {
        send(ch, resp.status as long);
    } else {
        send(ch, -1 as long);
    }
    return 0 as void*;
}

int main() {
    println("=== HTTP REST API Test ===");

    // Cmサーバスレッド起動
    ulong server = spawn(server_thread as void*);
    sleep_ms(100);

    // HttpClient初期化
    HttpClient client;
    client.init("127.0.0.1", 18300);

    // ============================================================
    // テスト1: GET /api/hello
    // ============================================================
    HttpResponse r1 = client.get("/api/hello");
    if (r1.is_ok == 1) {
        println("GET /api/hello: {r1.status}");
        println("Body: {r1.body}");
        if (r1.status == 200) {
            println("TEST1: PASS");
        } else {
            println("TEST1: FAIL (status={r1.status})");
        }
    } else {
        println("TEST1: FAIL ({r1.err_msg})");
    }

    // ============================================================
    // テスト2: POST /api/echo
    // ============================================================
    HttpResponse r2 = client.post("/api/echo", "{\"name\": \"Cm\"}");
    if (r2.is_ok == 1) {
        println("POST /api/echo: {r2.status}");
        println("Body: {r2.body}");
        if (r2.status == 200) {
            println("TEST2: PASS");
        } else {
            println("TEST2: FAIL (status={r2.status})");
        }
    } else {
        println("TEST2: FAIL ({r2.err_msg})");
    }

    // ============================================================
    // テスト3: PUT /api/update
    // ============================================================
    HttpResponse r3 = client.put("/api/update", "{\"key\": \"value\"}");
    if (r3.is_ok == 1) {
        println("PUT /api/update: {r3.status}");
        println("Body: {r3.body}");
        if (r3.status == 200) {
            println("TEST3: PASS");
        } else {
            println("TEST3: FAIL (status={r3.status})");
        }
    } else {
        println("TEST3: FAIL ({r3.err_msg})");
    }

    // ============================================================
    // テスト4: DELETE /api/remove
    // ============================================================
    HttpResponse r4 = client.delete_req("/api/remove");
    if (r4.is_ok == 1) {
        println("DELETE /api/remove: {r4.status}");
        println("Body: {r4.body}");
        if (r4.status == 200) {
            println("TEST4: PASS");
        } else {
            println("TEST4: FAIL (status={r4.status})");
        }
    } else {
        println("TEST4: FAIL ({r4.err_msg})");
    }

    // ============================================================
    // テスト5: GET /api/not_found → 404
    // ============================================================
    HttpResponse r5 = client.get("/api/not_found");
    if (r5.is_ok == 1) {
        println("GET /api/not_found: {r5.status}");
        println("Body: {r5.body}");
        if (r5.status == 404) {
            println("TEST5: PASS (404 correctly returned)");
        } else {
            println("TEST5: FAIL (expected 404, got {r5.status})");
        }
    } else {
        println("TEST5: FAIL ({r5.err_msg})");
    }

    // ============================================================
    // テスト6: 接続失敗テスト（別ポート）
    // ============================================================
    HttpClient bad_client;
    bad_client.init("127.0.0.1", 19999);
    HttpResponse r6 = bad_client.get("/api/hello");
    if (r6.is_ok == 1) {
        println("TEST6: FAIL (expected failure)");
    } else {
        println("Connection refused: {r6.err_msg}");
        println("TEST6: PASS (refused handled)");
    }

    // ============================================================
    // テスト7: 非同期並列GETリクエスト (thread + channel)
    // ============================================================
    long ch = create(4);
    ulong t1 = spawn_with_arg(async_get_worker as void*, ch as void*);
    ulong t2 = spawn_with_arg(async_get_worker as void*, ch as void*);

    long result1 = 0;
    long result2 = 0;
    recv(ch, &result1);
    recv(ch, &result2);

    join(t1);
    join(t2);
    destroy(ch);

    if (result1 == 200 && result2 == 200) {
        println("Async GET results: {result1}, {result2}");
        println("TEST7: PASS (async requests OK)");
    } else {
        println("TEST7: FAIL (results: {result1}, {result2})");
    }

    // サーバスレッド終了待機
    join(server);
    println("=== Done ===");
    return 0;
}
