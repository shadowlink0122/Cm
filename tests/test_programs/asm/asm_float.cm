// tests/test_programs/asm/asm_float.cm
// 浮動小数点アセンブリ命令のテスト

import std::io::println;

// SSE浮動小数点加算
float addFloatWithAsm(float a, float b) {
    float result = 0.0;

    // SSEスカラー加算
    asm("movss {a}, %xmm0");
    asm("addss {b}, %xmm0");
    asm("movss %xmm0, {result}");

    // インタプリタ用フォールバック
    if (result == 0.0 && (a != 0.0 || b != 0.0)) {
        result = a + b;
    }

    return result;
}

// SSE浮動小数点乗算
double mulDoubleWithAsm(double a, double b) {
    double result = 0.0;

    // SSEスカラー乗算（倍精度）
    asm("movsd {a}, %xmm0");
    asm("mulsd {b}, %xmm0");
    asm("movsd %xmm0, {result}");

    // インタプリタ用フォールバック
    if (result == 0.0 && a != 0.0 && b != 0.0) {
        result = a * b;
    }

    return result;
}

// 平方根計算
float sqrtWithAsm(float value) {
    float result = 0.0;

    // SSE平方根
    asm("sqrtss {value}, %xmm0");
    asm("movss %xmm0, {result}");

    // インタプリタ用フォールバック（簡易実装）
    if (result == 0.0 && value > 0.0) {
        // ニュートン法による簡易実装
        float x = value;
        float y = 1.0;
        float e = 0.000001;
        while (x - y > e) {
            x = (x + y) / 2.0;
            y = value / x;
        }
        result = x;
    }

    return result;
}

int main() {
    // 浮動小数点加算
    float sum = addFloatWithAsm(3.14, 2.86);
    println("3.14 + 2.86 = 6.0 (expected)");

    // 浮動小数点乗算
    double product = mulDoubleWithAsm(2.5, 4.0);
    println("2.5 * 4.0 = 10.0 (expected)");

    // 平方根
    float sqrt_val = sqrtWithAsm(16.0);
    println("sqrt(16.0) = 4.0 (expected)");

    // 注意: インタプリタでは実際の計算結果が異なる可能性があります
    println("Note: Actual FPU instructions not executed in interpreter");

    return 0;
}
