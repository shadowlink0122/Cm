// test_pqueue_simple.cm - シンプルなジェネリックPQueueテスト
// Tが構造体の場合をテスト

import std::io::println;

use libc {
    void* malloc(ulong size);
    void free(void* ptr);
}

// テスト用の構造体（優先度を持つ要素）
struct Item {
    int value;
    int priority;
}

// シンプルなジェネリックノード
struct Node<T> {
    T data;
    Node<T>* next;
}

// シンプルなジェネリックキュー（リンクリストベース）
struct SimpleQueue<T> {
    Node<T>* head;
    int size;
}

// ============================================================
// ヘルパー関数
// ============================================================

// ノード作成
<T> Node<T>* new_node(T data) {
    void* mem = malloc(sizeof(Node<T>));
    Node<T>* node = mem as Node<T>*;
    node->data = data;
    node->next = null as Node<T>*;
    return node;
}

// キュー初期化
<T> void queue_init(SimpleQueue<T>* q) {
    q->head = null as Node<T>*;
    q->size = 0;
}

// 末尾に追加（シンプル版）
<T> void queue_push(SimpleQueue<T>* q, T data) {
    Node<T>* new_node_ptr = new_node(data);

    if (q->head == null) {
        q->head = new_node_ptr;
    } else {
        Node<T>* current = q->head;
        while (current->next != null) {
            current = current->next;
        }
        current->next = new_node_ptr;
    }
    q->size = q->size + 1;
}

// 先頭を取得して削除
<T> T queue_pop(SimpleQueue<T>* q) {
    Node<T>* head = q->head;
    T data = head->data;
    q->head = head->next;
    free(head as void*);
    q->size = q->size - 1;
    return data;
}

// キューが空か
<T> bool queue_is_empty(SimpleQueue<T>* q) {
    return q->size == 0;
}

// キューのサイズ
<T> int queue_len(SimpleQueue<T>* q) {
    return q->size;
}

// ============================================================
// メイン
// ============================================================
int main() {
    println("=== Simple Generic Queue Test ===");

    // Item構造体を使用するキュー
    SimpleQueue<Item> q = {head: null as Node<Item>*, size: 0};

    // 要素を追加
    println("\nPushing items:");

    Item item1 = {value: 100, priority: 1};
    queue_push(&q, item1);
    println("  push(value=100, priority=1)");

    Item item2 = {value: 200, priority: 2};
    queue_push(&q, item2);
    println("  push(value=200, priority=2)");

    Item item3 = {value: 300, priority: 3};
    queue_push(&q, item3);
    println("  push(value=300, priority=3)");

    int size = queue_len(&q);
    println("\nQueue size: {size}");

    // 要素を取り出し
    println("\nPopping items:");
    while (!queue_is_empty(&q)) {
        Item popped = queue_pop(&q);
        int v = popped.value;
        int p = popped.priority;
        println("  pop() = value={v}, priority={p}");
    }

    println("\n=== Done ===");
    return 0;
}
