// UEFI メモリ管理テスト
// Boot ServicesのAllocatePool/FreePoolを使用
//
// ビルド: cm compile --target=uefi -o memory_test.o memory_test.cm

import uefi::table::*;
import uefi::text::*;
import uefi::mem::*;
import uefi::types::*;

ulong efi_main(EfiHandle image_handle, EfiSystemTable* system_table) {
    uefi_clear_screen(system_table);
    uefi_println(system_table, "UEFI Memory Test");
    uefi_println(system_table, "================");

    // メモリプール割り当てテスト
    void* buffer = 0 as void*;
    ulong status = uefi_alloc_pool(system_table, 4096, &buffer);

    if (efi_error(status)) {
        uefi_set_color(system_table, EFI_RED);
        uefi_println(system_table, "FAIL: AllocatePool failed");
    } else {
        uefi_set_color(system_table, EFI_GREEN);
        uefi_println(system_table, "PASS: AllocatePool (4096 bytes)");

        // バッファに書き込みテスト
        utiny* p = buffer as utiny*;
        *p = 42;

        // メモリ解放
        status = uefi_free_pool(system_table, buffer);
        if (efi_error(status)) {
            uefi_set_color(system_table, EFI_RED);
            uefi_println(system_table, "FAIL: FreePool failed");
        } else {
            uefi_println(system_table, "PASS: FreePool");
        }
    }

    // ページ割り当てテスト
    ulong page_addr = 0;
    status = uefi_alloc_pages(system_table, 1, &page_addr);

    if (efi_error(status)) {
        uefi_set_color(system_table, EFI_RED);
        uefi_println(system_table, "FAIL: AllocatePages failed");
    } else {
        uefi_set_color(system_table, EFI_GREEN);
        uefi_println(system_table, "PASS: AllocatePages (1 page)");

        // ページ解放
        status = uefi_free_pages(system_table, page_addr, 1);
        if (efi_error(status)) {
            uefi_set_color(system_table, EFI_RED);
            uefi_println(system_table, "FAIL: FreePages failed");
        } else {
            uefi_println(system_table, "PASS: FreePages");
        }
    }

    // Stallテスト（1秒待機）
    uefi_set_color(system_table, EFI_WHITE);
    uefi_println(system_table, "");
    uefi_println(system_table, "Stalling for 1 second...");
    uefi_stall(system_table, 1000000);  // 1秒 = 1,000,000マイクロ秒
    uefi_println(system_table, "Done!");

    // HLTループ
    while (true) {
        __asm__("hlt");
    }

    return 0;
}
