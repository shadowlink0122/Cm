name: Release Build

on:
  workflow_dispatch:
    inputs:
      version:
        description: '„É™„É™„Éº„Çπ„Éê„Éº„Ç∏„Éß„É≥ (‰æã: 0.14.0)'
        required: true
        type: string
      arch:
        description: '„Çø„Éº„Ç≤„ÉÉ„Éà„Ç¢„Éº„Ç≠„ÉÜ„ÇØ„ÉÅ„É£'
        required: true
        type: choice
        options:
          - arm64
          - x86_64
        default: 'arm64'

env:
  LLVM_VERSION: "17"

jobs:
  # ========================================
  # „Éê„Éº„Ç∏„Éß„É≥Ê§úË®º
  # ========================================
  verify:
    name: „Éê„Éº„Ç∏„Éß„É≥Ê§úË®º
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: „Éê„Éº„Ç∏„Éß„É≥Êï¥Âêà„ÉÅ„Çß„ÉÉ„ÇØ
        run: |
          FILE_VERSION=$(cat VERSION | tr -d '[:space:]')
          INPUT_VERSION="${{ inputs.version }}"
          
          if [ "$FILE_VERSION" != "$INPUT_VERSION" ]; then
            echo "::error::„Éê„Éº„Ç∏„Éß„É≥‰∏ç‰∏ÄËá¥! VERSION: ${FILE_VERSION}, ÂÖ•Âäõ: ${INPUT_VERSION}"
            exit 1
          fi
          
          # VSCodeÊã°Âºµ„Éê„Éº„Ç∏„Éß„É≥„ÉÅ„Çß„ÉÉ„ÇØ
          PKG_VERSION=$(node -p "require('./vscode-extension/package.json').version")
          if [ "$FILE_VERSION" != "$PKG_VERSION" ]; then
            echo "::error::VSCodeÊã°Âºµ„Éê„Éº„Ç∏„Éß„É≥‰∏ç‰∏ÄËá¥! VERSION: ${FILE_VERSION}, package.json: ${PKG_VERSION}"
            exit 1
          fi
          
          echo "‚úÖ „Éê„Éº„Ç∏„Éß„É≥Ê§úË®ºOK: v${FILE_VERSION}"

  # ========================================
  # „É™„É™„Éº„Çπ„Éì„É´„Éâ
  # ========================================
  build:
    name: „É™„É™„Éº„Çπ„Éì„É´„Éâ (${{ inputs.arch }})
    needs: verify
    runs-on: ${{ inputs.arch == 'arm64' && 'macos-14' || 'ubuntu-22.04' }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Install LLVM (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          wget https://apt.llvm.org/llvm.sh && chmod +x llvm.sh
          sudo ./llvm.sh ${{ env.LLVM_VERSION }}
          sudo apt-get install -y llvm-${{ env.LLVM_VERSION }}-dev clang-${{ env.LLVM_VERSION }} libssl-dev
          echo "/usr/lib/llvm-${{ env.LLVM_VERSION }}/bin" >> $GITHUB_PATH
          echo "LLVM_DIR=/usr/lib/llvm-${{ env.LLVM_VERSION }}/lib/cmake/llvm" >> $GITHUB_ENV

      - name: Install LLVM (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install llvm@${{ env.LLVM_VERSION }} openssl@3
          echo "$(brew --prefix llvm@${{ env.LLVM_VERSION }})/bin" >> $GITHUB_PATH
          echo "LDFLAGS=-L$(brew --prefix llvm@${{ env.LLVM_VERSION }})/lib" >> $GITHUB_ENV
          echo "CPPFLAGS=-I$(brew --prefix llvm@${{ env.LLVM_VERSION }})/include" >> $GITHUB_ENV
          echo "LLVM_DIR=$(brew --prefix llvm@${{ env.LLVM_VERSION }})/lib/cmake/llvm" >> $GITHUB_ENV
          echo "OPENSSL_ROOT_DIR=$(brew --prefix openssl@3)" >> $GITHUB_ENV

      # Release„É¢„Éº„Éâ„Åß„Ç≥„É≥„Éë„Ç§„É©„Éì„É´„Éâ
      - name: „Ç≥„É≥„Éë„Ç§„É©„Éì„É´„Éâ (Release)
        run: |
          CMAKE_EXTRA_FLAGS=""
          if [ "$RUNNER_OS" = "macOS" ]; then
            CMAKE_EXTRA_FLAGS="-DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3)"
          fi
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCM_USE_LLVM=ON \
            -DCM_TARGET_ARCH=${{ inputs.arch }} \
            $CMAKE_EXTRA_FLAGS
          cmake --build build -j$(nproc 2>/dev/null || sysctl -n hw.ncpu)

      # std„É©„É≥„Çø„Ç§„É†„É©„Ç§„Éñ„É©„É™„Éì„É´„Éâ
      - name: „É©„É≥„Çø„Ç§„É†„É©„Ç§„Éñ„É©„É™„Éì„É´„Éâ
        run: make libs ARCH=${{ inputs.arch }}

      - name: „Éì„É´„ÉâÊ§úË®º
        run: |
          echo "=== Build Verification ==="
          ./cm --version
          echo "=== Runtime Libraries ==="
          ls -la build/lib/
          echo "‚úÖ Release build complete (${{ inputs.arch }})"

      # VSCodeÊã°Âºµ„Éë„ÉÉ„Ç±„Éº„Ç∏„É≥„Ç∞
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: VSCodeÊã°Âºµ„Éë„ÉÉ„Ç±„Éº„Ç∏„É≥„Ç∞
        working-directory: vscode-extension
        run: |
          npm install
          npm run compile
          npm run verify-version
          npx @vscode/vsce package --allow-missing-repository --skip-license
          echo "‚úÖ VSCode extension packaged"

      # ÈÖçÂ∏ÉÁâ©ÊßãÁØâ
      - name: ÈÖçÂ∏ÉÁâ©ÊßãÁØâ
        run: |
          VERSION="${{ inputs.version }}"
          OS=$(uname -s | tr 'A-Z' 'a-z')
          ARCH="${{ inputs.arch }}"
          DIST_DIR="dist/cm-v${VERSION}-${OS}-${ARCH}"
          
          rm -rf "${DIST_DIR}"
          mkdir -p "${DIST_DIR}"/{bin,lib,vscode-extension,docs/tutorials,examples}
          
          # „Ç≥„É≥„Éë„Ç§„É©„Éê„Ç§„Éä„É™
          cp cm "${DIST_DIR}/bin/"
          
          # „É©„É≥„Çø„Ç§„É†„É©„Ç§„Éñ„É©„É™
          cp build/lib/*.o build/lib/*.a "${DIST_DIR}/lib/" 2>/dev/null || true
          
          # VSCodeÊã°Âºµ
          cp vscode-extension/cm-language-*.vsix "${DIST_DIR}/vscode-extension/" 2>/dev/null || true
          
          # „ÉÅ„É•„Éº„Éà„É™„Ç¢„É´
          cp -r docs/tutorials/ja "${DIST_DIR}/docs/tutorials/"
          cp -r docs/tutorials/en "${DIST_DIR}/docs/tutorials/"
          
          # GitHub Pages„É™„É≥„ÇØÊ°àÂÜÖ
          cat > "${DIST_DIR}/docs/DOCUMENTATION.md" << 'EOF'
          # Cm „Éâ„Ç≠„É•„É°„É≥„Éà
          
          ## „Ç™„É≥„É©„Ç§„É≥„Éâ„Ç≠„É•„É°„É≥„Éà
          
          ÊúÄÊñ∞„ÅÆ„Éâ„Ç≠„É•„É°„É≥„Éà„ÅØGitHub Pages„ÅßÂÖ¨Èñã„Åï„Çå„Å¶„ÅÑ„Åæ„ÅôÔºö
          
          üåê https://shadowlink0122.github.io/Cm/
          
          - [„ÇØ„Ç§„ÉÉ„ÇØ„Çπ„Çø„Éº„Éà](https://shadowlink0122.github.io/Cm/QUICKSTART.html)
          - [Ë®ÄË™û‰ªïÊßò](https://shadowlink0122.github.io/Cm/design/CANONICAL_SPEC.html)
          - [„ÉÅ„É•„Éº„Éà„É™„Ç¢„É´‰∏ÄË¶ß](https://shadowlink0122.github.io/Cm/tutorials/)
          - [Ê©üËÉΩ„É™„Éï„Ç°„É¨„É≥„Çπ](https://shadowlink0122.github.io/Cm/features/)
          - [„É™„É™„Éº„Çπ„Éé„Éº„Éà](https://shadowlink0122.github.io/Cm/releases/)
          
          ## „Ç™„Éï„É©„Ç§„É≥„Éâ„Ç≠„É•„É°„É≥„Éà
          
          „Åì„ÅÆ„Ç¢„Éº„Ç´„Ç§„Éñ„Å´„ÅØ‰ª•‰∏ã„ÅÆ„Éâ„Ç≠„É•„É°„É≥„Éà„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Åæ„ÅôÔºö
          
          - `tutorials/ja/` - Êó•Êú¨Ë™û„ÉÅ„É•„Éº„Éà„É™„Ç¢„É´
          - `tutorials/en/` - Ëã±Ë™û„ÉÅ„É•„Éº„Éà„É™„Ç¢„É´
          EOF
          # „Ç§„É≥„Éá„É≥„ÉàÈô§Âéª
          sed -i.bak 's/^          //' "${DIST_DIR}/docs/DOCUMENTATION.md" && rm -f "${DIST_DIR}/docs/DOCUMENTATION.md.bak"
          
          # „Çµ„É≥„Éó„É´„Ç≥„Éº„ÉâÔºànode_modulesÈô§Â§ñÔºâ
          cp -r examples/* "${DIST_DIR}/examples/"
          find "${DIST_DIR}/examples" -name "node_modules" -type d -exec rm -rf {} + 2>/dev/null || true
          find "${DIST_DIR}/examples" -name ".DS_Store" -delete 2>/dev/null || true
          
          # README & VERSION
          cp README.md VERSION "${DIST_DIR}/"
          
          # „Ç¢„Éº„Ç´„Ç§„Éñ‰ΩúÊàê
          (cd dist && tar czf "cm-v${VERSION}-${OS}-${ARCH}.tar.gz" "cm-v${VERSION}-${OS}-${ARCH}/")
          
          echo "=== Distribution Contents ==="
          find "${DIST_DIR}" -type f | head -30
          echo "..."
          echo "=== Archive ==="
          ls -lh "dist/cm-v${VERSION}-${OS}-${ARCH}.tar.gz"
          echo "‚úÖ Distribution build complete!"

      # „Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„Éà„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
      - name: „Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„Éà„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
        uses: actions/upload-artifact@v4
        with:
          name: cm-v${{ inputs.version }}-${{ runner.os }}-${{ inputs.arch }}
          path: |
            dist/cm-v${{ inputs.version }}-*.tar.gz
          retention-days: 90
