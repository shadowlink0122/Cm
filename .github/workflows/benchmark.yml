name: Benchmark

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  benchmark:
    name: Run Benchmarks
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Install LLVM
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 17
          sudo apt-get install -y llvm-17-dev clang-17
          echo "/usr/lib/llvm-17/bin" >> $GITHUB_PATH
          echo "LLVM_DIR=/usr/lib/llvm-17/lib/cmake/llvm" >> $GITHUB_ENV

      - name: Install Google Test
        run: sudo apt-get install -y libgtest-dev

      - name: Configure CMake
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCM_USE_LLVM=ON

      - name: Build
        run: cmake --build build -j$(nproc)

      - name: Run All Benchmarks
        run: |
          echo "=== Running Cm JIT Benchmarks ==="
          
          PASS=0
          FAIL=0
          
          for bench in 06_prime_sieve 07_fibonacci_memoized 04_array_sort 05_matrix_multiply; do
            echo ""
            echo "--- $bench ---"
            
            if [ -f "tests/bench_marks/cm/${bench}.cm" ]; then
              echo "Running tests/bench_marks/cm/${bench}.cm..."
              if timeout 120 ./build/bin/cm run tests/bench_marks/cm/${bench}.cm > /dev/null 2>&1; then
                echo "✅ $bench: PASS"
                PASS=$((PASS + 1))
              else
                echo "❌ $bench: FAIL"
                FAIL=$((FAIL + 1))
              fi
            else
              echo "⚠️ $bench: SKIP (file not found)"
            fi
          done
          
          echo ""
          echo "=== Benchmark Results ==="
          echo "Passed: $PASS"
          echo "Failed: $FAIL"
          
          # ベンチマーク失敗はCIを失敗させない（警告のみ）
          if [ $FAIL -gt 0 ]; then
            echo "⚠️ Some benchmarks failed (non-critical)"
          else
            echo "✅ All benchmarks passed!"
          fi