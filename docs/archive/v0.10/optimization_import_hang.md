[English](optimization_import_hang.en.html)

# LLVM最適化時のインポート無限ループ問題

## ステータス: ✅ 解決済み (2026-01-04)

## 問題の概要

日時: 2026-01-02
報告者: ユーザー
調査者: Claude

### 症状
- プログラムに`import`文が含まれている場合、O1-O3最適化でコンパイルが無限ループに陥る
- コンパイラ自体がハングし、タイムアウトしても終了しない
- macOSでプロセスステータスが"UE+"（uninterruptible I/O + trying to exit）になる

## 解決策

### 実施した修正 (2026-01-04)

1. **MIR最適化パイプラインv2の再有効化**
   - タイムアウト機能と収束判定機能付きのv2パイプラインを再有効化
   - `src/mir/passes/core/manager.hpp`: `run_until_fixpoint_v2()`を使用

2. **収束管理の改善**
   - `src/mir/passes/convergence/manager.hpp`: 未使用変数の警告を修正
   - 振動検出ロジックの改善

3. **タイムアウトガードの修正**
   - `src/mir/passes/core/timeout_guard.hpp`: メンバ初期化順序の警告を修正

4. **DCEパスの改善**（以前の修正）
   - Derefプロジェクションの使用追跡を正しく処理
   - フィールドプロジェクションのベース変数の使用追跡

### テスト結果 (修正後)

```
# 30個のテストファイルをO3で実行
Total: 30, Pass: 30, Fail: 0
```

- O0: ✅ コンパイル成功、実行成功
- O1: ✅ コンパイル成功、実行成功
- O2: ✅ コンパイル成功、実行成功
- O3: ✅ コンパイル成功、実行成功

## 技術的詳細

### 根本原因
1. **MIR最適化の収束判定の問題**
   - v1パイプラインには十分な安全機構がなかった
   - v2パイプラインは存在したが、一時的に無効化されていた

2. **DCEパスでの使用変数追跡の不完全性**
   - ポインタ操作（Deref）やフィールドアクセス時のベース変数が
     使用されていると正しく認識されていなかった

### 対策の仕組み
1. **タイムアウト機能**: 全体で30秒、各パスで5秒の制限
2. **循環検出**: ハッシュベースの状態履歴（8回分）で循環を検出
3. **振動検出**: 変更パターンの繰り返しを検出
4. **パス実行回数制限**: 同じパスの過度な実行を防止

## 関連ファイル
- `/src/mir/passes/core/manager.hpp` - 最適化マネージャー
- `/src/mir/passes/core/pipeline_v2.hpp` - v2パイプライン
- `/src/mir/passes/core/timeout_guard.hpp` - タイムアウト機能
- `/src/mir/passes/convergence/manager.hpp` - 収束管理
- `/src/mir/passes/cleanup/dce.hpp` - デッドコード除去