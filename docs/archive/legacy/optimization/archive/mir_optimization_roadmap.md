[English](mir_optimization_roadmap.en.html)

# Cm言語 最適化ロードマップ v0.12.0+

## 概要

このドキュメントは、Cm言語コンパイラにおける最適化実装の計画とステータスを記載します。
最適化は主に**MIR（中間表現）レベル**と**コード生成（CodeGen）レベル**で実施されます。

## 最適化レベル

### 実行時オプション
| レベル | オプション | 説明 | デフォルト |
|--------|------------|------|------------|
| O0 | `--no-opt`, `-O0` | 最適化なし（デバッグビルド） | |
| O1 | `-O1` | 基本最適化 | |
| O2 | `-O2` | 標準最適化 | |
| O3 | `-O3` | 積極的最適化 | ✅ |

### 各レベルで有効な最適化

#### O0（最適化なし）
- デバッグ情報の完全保持
- 実行順序の厳密な保持
- 最短コンパイル時間

#### O1（基本最適化）
- 定数畳み込み（Constant Folding）
- デッドコード除去（Dead Code Elimination）
- 基本的なインライン化

#### O2（標準最適化）
- O1のすべて
- 共通部分式除去（CSE）
- ループ不変式移動（LICM）
- 関数インライン化（積極的）

#### O3（積極的最適化）
- O2のすべて
- ループアンローリング
- ベクトル化
- 積極的なインライン化
- リンク時最適化（LTO）

## v0.12.0 - MIR共通最適化

### 実装ステータス
| 最適化 | フェーズ | O1 | O2 | O3 | ステータス | 備考 |
|--------|----------|----|----|----|-----------|----|
| 定数畳み込み | MIR-OPT | ✅ | ✅ | ✅ | ⚠️ 部分実装 | インポート時に無限ループ問題 |
| デッドコード除去 | MIR-OPT | ✅ | ✅ | ✅ | ⚠️ 部分実装 | インポート時に無限ループ問題 |
| 定数伝播（SCCP） | MIR-OPT | ✅ | ✅ | ✅ | ✅ 実装済み | |
| コピー伝播 | MIR-OPT | ✅ | ✅ | ✅ | ✅ 実装済み | |
| 共通部分式除去 | MIR-OPT | | ✅ | ✅ | ✅ 実装済み | Local GVN/CSE |
| デッドストア除去 | MIR-OPT | | ✅ | ✅ | ✅ 実装済み | DSE |
| 制御フロー簡約化 | MIR-OPT | | ✅ | ✅ | ✅ 実装済み | |
| インライン化 | MIR-OPT | ⏳ | ✅ | ✅ | ✅ 実装済み | |
| ループ不変式移動 | MIR-OPT | | ✅ | ✅ | ✅ 実装済み | LICM |

### 既知の問題

#### 🔴 クリティカル: インポート時の無限ループ（#optimization-import-hang）
- **影響**: O1-O3でインポートを含むプログラムがコンパイル不可
- **原因**: 外部関数の最適化処理での循環参照
- **一時対処**: インポート検出時に最適化をスキップ
- **根本対策**: 外部関数の適切な処理実装が必要

## v0.13.0 - プラットフォーム個別最適化

### LLVMバックエンド最適化
| 最適化 | フェーズ | O1 | O2 | O3 | ステータス |
|--------|----------|----|----|----|-----------|
| LLVMパス適用 | LLVM-OPT | ✅ | ✅ | ✅ | ✅ 実装済み |
| ターゲット固有最適化 | LLVM-OPT | | ✅ | ✅ | ✅ 実装済み |
| ベクトル化 | LLVM-OPT | | | ✅ | ✅ LLVMデフォルト |
| ループアンローリング | LLVM-OPT | | | ✅ | ✅ LLVMデフォルト |
| LTO（Link Time Optimization） | LLVM-OPT | | | ✅ | 🔄 計画中 |

### WASMバックエンド最適化
| 最適化 | フェーズ | O1 | O2 | O3 | ステータス |
|--------|----------|----|----|----|-----------|
| wasm-opt統合 | WASM-OPT | | ✅ | ✅ | 🔄 計画中 |
| バイナリサイズ最適化 | WASM-OPT | | ✅ | ✅ | 🔄 計画中 |
| SIMD活用 | WASM-OPT | | | ✅ | 🔄 計画中 |

### JavaScriptバックエンド最適化
| 最適化 | フェーズ | O1 | O2 | O3 | ステータス |
|--------|----------|----|----|----|-----------|
| 変数名短縮 | JS-OPT | | ✅ | ✅ | 🔄 計画中 |
| デッドコード除去 | JS-OPT | ✅ | ✅ | ✅ | 🔄 計画中 |
| インライン化 | JS-OPT | | ✅ | ✅ | 🔄 計画中 |
| Terser/esbuild統合 | JS-OPT | | | ✅ | 🔄 計画中 |

## v0.14.0 - 高度な最適化

### プロファイルガイド最適化（PGO）
| 機能 | フェーズ | ステータス |
|------|----------|-----------|
| プロファイル収集 | RUNTIME | 🔄 計画中 |
| プロファイル適用 | MIR-OPT | 🔄 計画中 |
| ホットパス最適化 | MIR-OPT | 🔄 計画中 |

### 自動ベクトル化
| 機能 | フェーズ | ステータス |
|------|----------|-----------|
| ループ解析 | MIR-ANALYSIS | 🔄 計画中 |
| SIMD命令生成 | LLVM-OPT | 🔄 計画中 |
| 自動並列化 | MIR-OPT | 🔄 計画中 |

### その他の高度な最適化
| 機能 | フェーズ | ステータス |
|------|----------|-----------|
| Global DSE / Memory Optimization | MIR-OPT | 🔄 計画中 |
| Alias Analysis | MIR-ANALYSIS | 🔄 計画中 |
| Tail Call Optimization | MIR-OPT | 🔄 計画中 |

## ファイル構造再編成計画

### 現在の構造（冗長性あり）
```
src/
├── mir/
│   └── optimizations/
│       ├── optimization_pass.hpp    ❌ 冗長
│       ├── constant_folding.hpp     ❌ 冗長
│       └── dead_code_elimination.hpp ❌ 冗長
└── codegen/
    ├── llvm/
    │   └── optimizations/
    │       └── llvm_optimization.hpp ❌ 冗長
    └── js/
        └── optimizations/
            └── js_optimization.hpp   ❌ 冗長
```

### 新しい構造（冗長性なし）
```
src/
├── mir/
│   ├── analysis/              # 解析パス
│   │   ├── dataflow.hpp      # データフロー解析
│   │   ├── dominance.hpp     # 支配関係解析
│   │   └── liveness.hpp      # 生存性解析
│   └── passes/                # 最適化パス
│       ├── base.hpp           # 基底クラス
│       ├── folding.hpp        # 定数畳み込み
│       ├── dce.hpp            # デッドコード除去
│       ├── cse.hpp            # 共通部分式除去
│       ├── licm.hpp           # ループ不変式移動
│       ├── inline.hpp         # インライン化
│       └── manager.hpp        # パスマネージャ
└── codegen/
    ├── llvm/
    │   └── passes/             # LLVM固有パス
    │       ├── vectorize.hpp   # ベクトル化
    │       └── lto.hpp         # LTO
    ├── wasm/
    │   └── passes/             # WASM固有パス
    │       └── size.hpp        # サイズ最適化
    └── js/
        └── passes/             # JS固有パス
            ├── minify.hpp      # 圧縮
            └── tree_shake.hpp  # ツリーシェイキング
```

## テスト戦略

### 最適化テスト
```bash
# 全最適化レベルでのテスト
make test-opt-all   # O0, O1, O2, O3すべてでテスト

# 個別レベルテスト
make test-opt-0     # O0のみ
make test-opt-1     # O1のみ
make test-opt-2     # O2のみ
make test-opt-3     # O3のみ

# 最適化の正確性検証
make test-opt-verify # 出力の一致を確認
```

### パフォーマンステスト
```bash
# ベンチマーク実行
make bench-opt      # 各最適化レベルの性能測定

# サイズ比較
make size-compare   # バイナリサイズの比較
```

## 実装優先順位

### Phase 1（v0.12.0）- 必須修正
1. ⚠️ インポート時の無限ループ問題の根本解決
2. ⚠️ デフォルト最適化レベルをO3に復帰
3. ✅ 基本的な最適化パスの安定化

### Phase 2（v0.13.0）- MIR最適化拡充
1. ✅ 定数伝播の実装（SCCP）
2. ✅ 共通部分式除去の実装（Local GVN/CSE）
3. ✅ 基本的なインライン化

### Phase 3（v0.14.0）- 高度な最適化
1. ループ最適化の強化
2. プロファイルガイド最適化
3. 自動ベクトル化

## 関連ドキュメント
- [最適化実装詳細](./implementation_details.html)
- [最適化パスAPI](./pass_api.html)
- [インポート無限ループ問題](../issues/optimization_import_hang.html)
- [パフォーマンステスト結果](./benchmarks.html)

## 凡例
- ✅ 実装済み
- ⚠️ 部分実装/問題あり
- 🔄 計画中
- ⏳ 次期実装予定
- ❌ 未実装/削除予定