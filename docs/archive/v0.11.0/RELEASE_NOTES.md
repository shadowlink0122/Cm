# Cm Language v0.11.0 Release Notes

## 概要
v0.11.0は、パフォーマンス最適化、イテレータサポート、ベンチマークフレームワーク、そして多数のバグ修正を含む大規模リリースです。特に配列・スライス処理の性能改善とインタプリタの安定性向上に重点を置いています。

## 主要な新機能

### 1. イテレータとfor-in構文のサポート
```cm
// 新しいfor-in構文でコレクションを反復処理
int[] arr = {1, 2, 3, 4, 5};
for (int x in arr) {
    println(x);
}

// カスタムイテレータのサポート
struct Range {
    int start;
    int end;
}
impl Range {
    Iterator<int> iter() { ... }
}
```

### 2. ベンチマークフレームワーク
- 包括的なベンチマークテストスイートを追加
- Python、C++、Rustとの性能比較が可能
- インタプリタとネイティブコンパイルの両方をサポート

### 3. パフォーマンス最適化
- 配列アクセスの性能を大幅改善（最大250倍高速化）
- インタプリタのスタックオーバーフロー問題を修正
- 行列演算の最適化（IKJ順序によるキャッシュ効率化）

## ソースコード変更点

### コンパイラコア（src/）

#### パーサー・フロントエンド
- **イテレータ展開**: `src/frontend/parser/iterator_expander.cpp` - for-in構文の自動展開
- **型システム強化**: 多次元配列サポート、配列フラット化の基盤実装
- **ジェネリック改善**: ジェネリック構造体フィールドのポインタ型解決

#### 中間表現（MIR）
- **最適化パス追加**: 配列アクセス最適化、ループ展開、定数伝播の改善
- **SSA形式強化**: より効率的なレジスタ割り当てのための改良
- **メモリアクセス最適化**: 連続メモリアクセスパターンの検出と最適化

#### インタプリタ
- **スタックオーバーフロー修正**: 再帰実行から反復実行への変換
  - `src/codegen/interpreter/interpreter.hpp`: execute_blockをwhile loopベースに変更
- **ポインタ演算サポート**: Lt/Le/Gt/Ge比較演算子を追加
- **メソッド呼び出し修正**: self参照のコピーバック処理を改善

#### LLVMバックエンド
- **組み込み関数追加**: `__builtin_expect`によるブランチ予測最適化
- **ベクトル化サポート**: SIMD命令の自動生成
- **デバッグ情報改善**: より詳細なスタックトレース出力

#### ランタイムライブラリ
- **メモリ管理**: `src/codegen/common/runtime_alloc.c` - カスタムアロケータの追加
- **ファイルI/O**: `src/codegen/common/runtime_file.c` - ファイル操作のサポート
- **プラットフォーム抽象化**: `runtime_platform.h`の大幅改善

### テスト（tests/）

#### ベンチマークテストスイート
- `tests/bench_marks/` - 包括的なベンチマークフレームワーク
  - 素数判定（篩アルゴリズム）
  - フィボナッチ数列（メモ化再帰）
  - 配列ソート（バブルソート、1000要素）
  - 行列乗算（500×500行列）
  - 二分探索

#### 新規テストケース
- **イテレータテスト**: `tests/test_programs/iterator/`
  - 基本的なfor-in展開
  - カスタムイテレータ
  - ネストしたイテレータ

- **スライス拡張テスト**: `tests/test_programs/slice/`
  - `multidim_slice.cm`: 多次元スライス操作
  - `slice_every.cm`: every述語関数
  - `slice_find.cm`: 要素検索
  - `slice_reduce.cm`: reduce操作
  - `slice_sortBy.cm`: カスタムソート

- **ポインタテスト強化**: `tests/test_programs/pointer/`
  - `pointer_arithmetic.cm`: ポインタ演算
  - `pointer_compare.cm`: ポインタ比較
  - `function_pointer.cm`: 関数ポインタのサポート

- **型システムテスト**: `tests/test_programs/types/`
  - `sizeof.cm`: sizeof演算子（224行の包括的テスト）
  - `typeof.cm`: typeof演算子
  - `typedef_pointer.cm`: typedefとポインタの組み合わせ

#### テストランナー改善
- `tests/unified_test_runner.sh` - 統合テストランナーの大幅改善
  - JITコンパイラサポート
  - 並列実行のサポート
  - より詳細なエラーレポート

### サンプルコード（examples/）

#### ディレクトリ構造の再編成
旧構造から番号付きの教育的な構造への移行：

```
examples/
├── 01_basics/          # 基本文法
│   ├── hello_world.cm
│   ├── variables.cm
│   └── control_flow.cm
├── 02_functions/       # 関数とジェネリック
│   ├── callbacks.cm
│   └── generics.cm
├── 03_ownership/       # 所有権とメモリ管理
│   ├── borrowing.cm
│   └── move_semantics.cm
├── 04_memory/         # メモリ管理
│   ├── heap_allocation.cm
│   └── raii_pattern.cm
├── 05_data_structures/ # データ構造
│   ├── linked_list.cm
│   ├── priority_queue.cm      # 基本実装
│   ├── priority_queue_oop.cm  # OOP版（316行）
│   └── pqueue_generic.cm      # ジェネリック版（294行）
└── 06_algorithms/     # アルゴリズム
    ├── dijkstra.cm
    └── memoization_dp.cm
```

#### 新規サンプル追加
- **優先度付きキュー実装**: 3つの異なるアプローチで実装
  - 基本版、OOP版、ジェネリック版
  - タスクスケジューラーの実装例付き

- **ダイクストラアルゴリズム**: グラフ最短経路問題の解法
- **動的計画法**: メモ化とDPテーブルの実装例

### CI/ビルドシステム

#### GitHub Actions改善（.github/workflows/ci.yml）
- より詳細なビルドマトリックス
- ベンチマークの自動実行
- コードカバレッジレポート

#### CMake改善
- ベンチマークターゲットの追加
- より効率的な依存関係管理
- クロスプラットフォームサポートの改善

## バグ修正

### インタプリタ
- 7908回以上の再帰呼び出しでのスタックオーバーフローを修正
- メソッド呼び出し後のselfコピーバック処理を修正
- extern宣言と実装の優先度問題を解決
- ポインタ比較演算子の欠落を修正

### 型システム
- ジェネリック構造体フィールドのポインタ型解決を修正
- 多次元配列の型チェックを改善
- typedef with ポインタの組み合わせを修正

### コード生成
- LLVMバックエンドでの配列アクセス最適化
- WASM出力での境界チェック改善
- デバッグ情報の精度向上

## パフォーマンス改善

### ベンチマーク結果（ネイティブコンパイル）
| テスト | 改善前 | 改善後 | 速度向上 |
|--------|--------|--------|----------|
| 行列乗算(500×500) | 3.2秒 | 0.013秒 | 246倍 |
| 素数判定(篩,10000) | 0.8秒 | 0.003秒 | 267倍 |
| 配列ソート(1000要素) | 0.5秒 | 0.002秒 | 250倍 |

### インタプリタ改善
- 無限再帰問題の解決
- メモリ使用量の削減（スタック使用量を80%削減）
- 実行速度の向上（平均20-30%高速化）

## 破壊的変更
- `constructor`キーワードは廃止（通常のメソッドとして実装）
- 一部のビルトイン関数のシグネチャ変更

## 既知の問題
- 多次元配列のフラット化は設計段階（実装は次バージョン）
- JITコンパイラは実験的機能
- Windows環境でのWASM出力に一部制限

## 今後の予定
- v0.12.0: 配列フラット化の完全実装
- v0.13.0: JITコンパイラの正式リリース
- v0.14.0: 並列処理サポート

## 謝辞
このリリースは多くのフィードバックとテストによって実現しました。特にベンチマーク設計と最適化提案に貢献してくださった方々に感謝します。