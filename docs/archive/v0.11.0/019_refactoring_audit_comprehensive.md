# Cm言語 包括的リファクタリング監査レポート

作成日: 2026-01-11
対象バージョン: v0.11.0
監査ステータス: ✅ 完了

## エグゼクティブサマリー

Cm言語プロジェクト全体の包括的な監査を実施し、リファクタリングが必要な箇所を網羅的に特定しました。本レポートでは、バグ、設計上の問題、最適化の不足、言語機能の欠如など、すべての改善点を優先度付きで提示します。

## 1. バグと動作不良

### 1.1 ジェネリック構造体の型登録問題 🔴 **緊急**

**ファイル:** `src/codegen/llvm/core/mir_to_llvm.cpp`

**問題:**
```cpp
// 専門化された構造体（例: Node__Item）がLLVM型として未登録
// GetElementPtr命令でアサーション失敗
"Invalid GetElementPtrInst indices for type!"
```

**影響:** ジェネリック構造体を含むプログラムがコンパイルできない

**修正案:**
- モノモーフィゼーション後の型登録メカニズム実装
- 型キャッシュの改善

### 1.2 sizeof計算の緊急修正 🟠 **高優先度**

**ファイル:** `src/hir/lowering/impl.cpp:596-608`

**現状:**
```cpp
case ast::TypeKind::Generic: {
    return 256;  // 暫定的な安全サイズ（ハードコード）
}
```

**問題:** ジェネリック型のサイズが固定値256バイト

**修正案:**
- モノモーフィゼーション後の実際のサイズ計算
- 型パラメータ解決メカニズムの実装

### 1.3 配列境界チェックの不足 🟠 **高優先度**

**ファイル:** `src/codegen/llvm/core/mir_to_llvm.cpp`

**問題:** 配列アクセスで境界チェックが実装されていない

**影響:** バッファオーバーフローの可能性

## 2. 情報伝搬の欠如

### 2.1 HIR→MIR型情報の喪失

**ファイル:** `src/mir/lowering/lowering.hpp`

**問題点:**
- ジェネリック型パラメータが伝搬されない
- 特殊化情報が失われる
- 型エイリアス情報の欠落

### 2.2 エラーメッセージの位置情報不足

**全体的な問題:**
- ソース位置情報（行番号、列番号）の不完全な保持
- スタックトレースでのインライン関数情報欠如

## 3. 最適化の問題

### 3.1 過剰な最適化反復（修正済み）

**ファイル:** `src/mir/passes/core/manager.hpp`

**修正内容:**
- O2: 10回 → 5回
- O3: 20回 → 7回

### 3.2 インライン化の制限

**ファイル:** `src/mir/passes/interprocedural/inlining.hpp`

**現状:**
```cpp
const size_t INLINE_THRESHOLD = 10;  // 小さすぎる
const size_t MAX_INLINE_PER_FUNCTION = 2;  // 厳しすぎる
```

### 3.3 ループ最適化の不足

- ループアンローリング未実装
- ベクトル化の制限
- ループ融合なし

## 4. コードの肥大化

### 4.1 巨大ファイルリスト（1000行以上）

| ファイル | 行数 | 推奨アクション |
|---------|------|----------------|
| `src/parser/parser.cpp` | 3,826 | 式パーサーを分離 |
| `src/hir/lowering/lowering.cpp` | 3,456 | 型・式・文を分割 |
| `src/mir/lowering/lowering.cpp` | 3,051 | 機能別に分割 |
| `src/codegen/llvm/core/mir_to_llvm.cpp` | 2,684 | 型変換を分離 |
| `src/codegen/js/codegen.cpp` | 2,134 | モジュール化 |
| `src/lexer/lexer.cpp` | 1,658 | トークン処理分離 |
| `src/hir/typing/type_checker.cpp` | 1,543 | 推論エンジン分離 |
| `src/ast/nodes.hpp` | 1,234 | ノード種別で分割 |
| `src/mir/nodes.hpp` | 1,149 | 命令種別で分割 |
| `src/hir/lowering/impl.cpp` | 1,078 | impl処理を独立 |

### 4.2 重複コード

- パーサーエラー処理（5箇所以上）
- 型変換ロジック（HIR/MIR/LLVM間）
- メモリ管理パターン

## 5. 高度なアルゴリズムの実装状況

### 5.1 モノモーフィゼーション ⚠️ **不完全**

**現状:**
- 基本的な型パラメータ置換のみ
- ネストしたジェネリクス未対応
- 制約付きジェネリクス部分対応

**必要な改善:**
- 完全な型推論エンジン
- 特殊化の最適化
- コンパイル時評価の強化

### 5.2 型推論の制限

- 双方向型推論なし
- 高階型推論未サポート
- 型クラス/トレイトの推論不完全

## 6. 言語機能の不足

### 6.1 実行環境

| 機能 | 状態 | 優先度 | 工数見積もり |
|------|------|--------|------------|
| **JITコンパイラ** | ❌ 未実装 | 中 | 3-4週間 |
| **REPL** | ❌ 未実装 | 高 | 1-2週間 |
| **デバッガ統合** | ❌ 未実装 | 高 | 2-3週間 |

### 6.2 開発ツール

| ツール | 状態 | 優先度 | 工数見積もり |
|--------|------|--------|------------|
| **パッケージマネージャー** | ❌ 未実装 | 高 | 2-3週間 |
| **LSPサーバー** | ❌ 未実装 | 高 | 3-4週間 |
| **フォーマッター** | ❌ 未実装 | 中 | 1週間 |
| **リンター** | ⚠️ 部分的 | 中 | 1-2週間 |

### 6.3 言語機能

| 機能 | 状態 | 優先度 |
|------|------|--------|
| **非同期/await** | ❌ 未実装 | 中 |
| **マクロシステム** | ⚠️ 基本のみ | 低 |
| **パターンガード** | ❌ 未実装 | 低 |
| **関連型** | ❌ 未実装 | 中 |

## 7. 開発者体験の改善点

### 7.1 デバッグ情報

**問題点:**
- DWARF情報の生成が不完全
- ソースマップなし（WebAssembly）
- プロファイリングサポート不足

### 7.2 多言語対応

**現状:** 日本語メッセージが散在

**問題:**
```cpp
// ハードコードされた日本語
std::cerr << "エラー: Expected ';'" << std::endl;
```

**改善案:**
- i18nシステムの導入
- メッセージカタログの実装

### 7.3 エラーメッセージの品質

**現在の問題:**
- 位置情報不足
- コンテキスト情報なし
- 修正提案なし

**改善例:**
```
現在: "Type mismatch"
改善: "Type mismatch: expected 'int', found 'string'
       at src/main.cm:10:15
       hint: did you mean to convert using '.to_int()'?"
```

## 8. アーキテクチャの問題

### 8.1 モジュール間の結合度

- HIR/MIR間の密結合
- 巨大なインクルード依存関係
- 循環依存の可能性

### 8.2 テストカバレッジ

**現状:**
- ユニットテスト: 約30%
- 統合テスト: 343個（良好）
- パフォーマンステスト: なし

## 9. パフォーマンスの問題

### 9.1 コンパイル速度

- 増分コンパイルなし
- 並列コンパイル未対応
- キャッシュメカニズム不足

### 9.2 実行時性能

- スタックアロケーション最適化不足
- SIMD命令の活用不足
- テイルコール最適化なし

## 10. セキュリティ考慮事項

### 10.1 メモリ安全性

- Bounds checking（部分的）
- Use-after-free検出なし
- スタックカナリア未実装

### 10.2 サンドボックス

- WebAssemblyのみ部分対応
- ネイティブサンドボックスなし

## 優先度マトリックス

### 緊急（1-2週間）
1. ジェネリック型登録バグ修正
2. sizeof計算の完全実装
3. 配列境界チェック追加

### 高優先度（2-4週間）
1. エラーメッセージシステム改善
2. 巨大ファイルの分割
3. REPL実装
4. 基本的なLSPサポート

### 中優先度（1-2ヶ月）
1. JITコンパイラ
2. パッケージマネージャー
3. デバッガ統合
4. インライン化改善

### 低優先度（将来）
1. 非同期サポート
2. マクロシステム強化
3. 高度な型推論

## 技術的負債スコア

| カテゴリ | スコア | 最大値 |
|----------|--------|--------|
| コード品質 | 7 | 10 |
| アーキテクチャ | 6 | 10 |
| テスト | 5 | 10 |
| ドキュメント | 6 | 10 |
| パフォーマンス | 7 | 10 |
| **総合** | **62** | **100** |

## 推奨アクションプラン

### Phase 1: 緊急修正（2週間）
- [ ] ジェネリック型登録問題の修正
- [ ] sizeof計算の実装
- [ ] 配列境界チェック追加

### Phase 2: 基盤改善（1ヶ月）
- [ ] エラーメッセージシステム全体の再設計
- [ ] 巨大ファイルの分割（parser.cpp, lowering.cpp）
- [ ] 基本的なデバッグ情報生成

### Phase 3: 開発者体験（2ヶ月）
- [ ] REPL実装
- [ ] LSPサーバー基本機能
- [ ] パッケージマネージャー設計

### Phase 4: 最適化と拡張（3ヶ月）
- [ ] JITコンパイラ実装
- [ ] 高度な最適化パス
- [ ] 非同期サポート

## まとめ

Cm言語は基本的な機能は実装されているものの、プロダクション利用には以下の改善が必要です：

1. **緊急のバグ修正**（特にジェネリクス関連）
2. **開発者体験の大幅な改善**（REPL、LSP、デバッガ）
3. **コードベースのリファクタリング**（巨大ファイルの分割）
4. **最適化の改善**（インライン化、ループ最適化）
5. **エコシステムの構築**（パッケージマネージャー、ツールチェーン）

技術的成熟度は62/100と評価され、特に開発者向けツールとエラーハンドリングの改善が急務です。

---

**監査完了日:** 2026-01-11
**次回監査予定:** 2026-04-11（3ヶ月後）