# Cm言語 最適化使用ガイド

## 基本理念
**「デフォルトで最高品質のバイナリを生成する」**

Cm言語のコンパイラは、デフォルトで最大最適化を行います。
これにより、ユーザーは特別なオプションを指定することなく、
最高性能のバイナリを得ることができます。

## コンパイルモード

### デフォルト（オプションなし）
```bash
cm compile program.cm
```
- **最大最適化を実行**
- 収束まで反復（変更数ベースの判定）
- 最高品質のバイナリを生成

### 高速コンパイル（--fast-compile, -fc）
```bash
cm compile --fast-compile program.cm
cm compile -fc program.cm  # 短縮形
```
- 基本的な最適化のみ
- 定数畳み込み、デッドコード削除
- コンパイル時間を優先

### 最適化無効（--no-opt）
```bash
cm compile --no-opt program.cm
```
- 最適化を完全にスキップ
- 最速のコンパイル
- デバッグ時の挙動確認用

### デバッグモード（--debug, -g）
```bash
cm compile --debug program.cm
cm compile -g program.cm  # 短縮形
```
- 最適化なし
- デバッグ情報を完全保持
- デバッガでの使用に最適

## 収束メカニズム

### 変更数ベースの判定
最適化の収束は「変更数のパターン」で判定します：

```
例1: 完全収束
反復1: 50変更
反復2: 20変更
反復3: 5変更
反復4: 0変更 → 完全収束！

例2: 安定収束
反復1: 30変更
反復2: 10変更
反復3: 10変更
反復4: 10変更 → 3回連続同じ = 安定収束！

例3: 振動パターン
反復1: 20変更
反復2: 15変更
反復3: 20変更
反復4: 15変更 → 振動検出 = 実用的収束
```

### 判定ロジック
1. **0変更** → 完全収束（即座に終了）
2. **同じ変更数が3回連続** → 安定収束（相互干渉）
3. **5変更以下が3回連続** → 実用的収束
4. **振動パターン** → 循環として収束

## パフォーマンス指標

### コンパイル時間の目安

| ファイルサイズ | デフォルト | --fast-compile | --no-opt |
|--------------|-----------|----------------|----------|
| 小（<100行）  | ~1秒      | ~0.2秒         | ~0.1秒   |
| 中（<1000行） | ~5秒      | ~1秒           | ~0.3秒   |
| 大（<10000行）| ~30秒     | ~5秒           | ~1秒     |

### バイナリ性能の比較

```
デフォルト:        100% (基準)
--fast-compile:    70-80%
--no-opt:          30-50%
```

## 使用例

### 開発中
```bash
# 頻繁なビルド・テスト
cm compile -fc main.cm

# デバッグ
cm compile -g main.cm
```

### リリース準備
```bash
# 最高性能（デフォルト）
cm compile main.cm

# 詳細ログ付き
cm compile --verbose main.cm
```

### ベンチマーク
```bash
# 最適化なしで基準測定
cm compile --no-opt bench.cm -o bench_base

# 最大最適化で測定
cm compile bench.cm -o bench_opt

# 性能比較
time ./bench_base
time ./bench_opt
```

## よくある質問

### Q: なぜデフォルトで最大最適化？
A: ユーザーが意識せずとも最高品質のバイナリを得られるようにするためです。
   「速いコンパイル」より「速いプログラム」を優先します。

### Q: コンパイルが遅い場合は？
A: 開発中は `--fast-compile` を使用してください。
   リリースビルドのみデフォルト設定を使うことを推奨します。

### Q: 最適化でバグが発生した場合は？
A: `--no-opt` で最適化を無効にして原因を特定してください。
   最適化バグはコンパイラの問題なので、issueで報告をお願いします。

### Q: 収束しない場合は？
A: 安全装置により100回で打ち切られます。
   これが頻発する場合は、コードの複雑性を見直すか、
   `--fast-compile` の使用を検討してください。

## 推奨ワークフロー

```bash
# 1. 開発フェーズ
cm compile -fc src/*.cm  # 高速ビルド

# 2. テストフェーズ
cm compile -g src/*.cm   # デバッグ情報付き

# 3. 統合テスト
cm compile src/*.cm      # デフォルト（最適化）

# 4. リリース
cm compile src/*.cm      # 同じ（既に最適化済み）
```

## まとめ

- **デフォルト = 最高品質** を実現
- 必要に応じて速度優先オプション提供
- 変更数ベースの賢い収束判定
- ユーザーの手間を最小化

「良いものをデフォルトに」という哲学で、
Cm言語は最高のパフォーマンスを提供します。