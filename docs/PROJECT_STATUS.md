# Cm言語プロジェクト 現状と次のステップ

## 🎯 プロジェクト概要

**Cm（シーマイナー）** - LLVMベースのネイティブコンパイラ

- **インタープリタ**: MIR直接実行（動作）
- **LLVMバックエンド**: ネイティブコード生成（**唯一のコード生成バックエンド**）
- **型システム**: 明示的型宣言、基本型完全サポート
- **オーバーロード**: 明示的な多重定義サポート

> **Note**: 2024年12月より、LLVMバックエンドを唯一のコード生成方式として採用しています。
> Rust/TypeScript/C++へのトランスパイルは今後行いません（ソースコードは参考のため保持）。

## ✅ 完了済み

### コンパイラ基盤
- [x] **Lexer**: 字句解析器
- [x] **Parser**: 構文解析器（基本構文）
- [x] **AST**: 抽象構文木
- [x] **HIR**: 高レベル中間表現
- [x] **MIR**: 中レベル中間表現（SSA形式）
- [x] **MIR最適化**: 基本的な最適化パス

### バックエンド
- [x] **LLVMバックエンド**: ネイティブコード生成（**メインバックエンド**）
  - 基本型（int, uint, tiny, utiny, short, ushort, float, double, bool, char, string）
  - 制御フロー（if/else, for, while, switch）
  - 関数（定義、呼び出し、再帰）
  - フォーマット文字列（Rustスタイル `{}`）
  - フォーマット指定子（`:x`, `:X`, `:b`, `:o`, `:.N`, `:e`, `:E`, `:<N`, `:>N`, `:^N`, `:0>N`）

### 廃止されたバックエンド（参考のため保持）
- [x] ~~Rustトランスパイラ~~: **廃止** - LLVMバックエンドに置き換え
- [x] ~~TypeScriptトランスパイラ~~: **廃止** - LLVMバックエンドに置き換え

### ドキュメント
- [x] 言語仕様（CANONICAL_SPEC.md）
- [x] アーキテクチャ設計
- [x] テストフレームワーク設計
- [x] LLVMバックエンド実装ガイド
- [x] LLVMランタイムライブラリドキュメント

### テスト基盤
- [x] 統一テストシステム（.cm + .expect）
- [x] マルチバックエンド対応テストランナー
- [x] LLVMバックエンドテスト（39テスト全パス）
- [x] リグレッション/統合テスト

## 📊 コンポーネント成熟度

| コンポーネント | 成熟度 | 備考 |
|--------------|--------|------|
| Lexer | ⭐⭐⭐⭐⭐ | 完成 |
| Parser | ⭐⭐⭐⭐☆ | 基本構文完成 |
| Type Checker | ⭐⭐⭐☆☆ | 基本型対応済み |
| HIR | ⭐⭐⭐⭐☆ | 基本完成 |
| MIR | ⭐⭐⭐⭐☆ | 基本完成 |
| Interpreter | ⭐⭐⭐☆☆ | 基本動作 |
| LLVM Backend | ⭐⭐⭐⭐☆ | 基本機能完成、全39テストパス |
| WASM (via LLVM) | ⭐⭐☆☆☆ | 計画中 |

## 🔧 現在の課題

### 1. 構造体/配列の未実装
```
問題: 構造体と配列の完全なサポートが必要
影響: 複雑なデータ構造を扱うプログラムが書けない
```

### 2. メモリ管理
```
問題: フォーマット関数で割り当てられたメモリが解放されない
影響: 長時間実行プログラムでメモリリーク
```

### 3. ジェネリクス
```
未実装:
- ジェネリクス構文（<T: Trait>）
- impl ブロック
```

## 📋 次のステップ（優先順位順）

### Step 1: 構造体の実装
- [ ] 構造体定義のパース
- [ ] 構造体型のHIR/MIR表現
- [ ] LLVM IRへの変換

### Step 2: 配列の完全サポート
- [ ] 配列リテラルのパース
- [ ] 配列アクセス
- [ ] 配列の長さ取得

### Step 3: メモリ管理の改善
- [ ] アリーナアロケータの導入
- [ ] スコープベースの自動解放
- [ ] または簡易GCの実装

### Step 4: ジェネリクス基本実装
- [ ] ジェネリクス構文のパース
- [ ] 型パラメータの解決
- [ ] 特殊化の実装

## 🚀 開発ロードマップ

### Phase 1: 構造体と配列（〜2週間）
- 構造体定義と使用
- 配列操作
- テストカバレッジ追加

### Phase 2: メモリ管理（〜1週間）
- アリーナアロケータ実装
- ランタイムライブラリ更新
- メモリリークテスト

### Phase 3: ジェネリクス（〜1ヶ月）
- 基本的なジェネリクス関数
- ジェネリック構造体
- トレイト基本実装

### Phase 4: WebAssemblyターゲット（〜2週間）
- LLVM経由でのWASM出力
- WASIランタイム対応
- テストスイート

## 🎯 最近の成果

### LLVMバックエンドの完成度向上（2024年12月10日）

- 全39のLLVMテストがパス
- フォーマット文字列の完全サポート
- 符号付き/符号なし整数の正しい処理
- FFI対応の標準ライブラリ

**テスト結果**:
```
Testing category: basic ............ 13/13 PASS
Testing category: control_flow ..... 9/9 PASS
Testing category: errors ........... 3/3 PASS
Testing category: formatting ....... 3/3 PASS
Testing category: types ............ 8/8 PASS
Testing category: functions ........ 3/3 PASS
Total: 39/39 PASS
```

## 📝 メモ

- MIRベースアーキテクチャは良い設計判断
- テストフレームワークは十分整備済み
- ドキュメントは充実
- LLVMバックエンドは本番品質に近づいている

---

更新日: 2024年12月10日