# ツール基盤（Lint/Format/LSP）のアーキテクチャ設計提案

**日付**: 2026年1月5日
**作成者**: Gemini Agent
**概要**: Cm言語の周辺ツール（リンター、フォーマッタ、Language Server）を効率的に開発・維持するためのアーキテクチャ設計。

## 1. 現状の分析と課題

現在のディレクトリ構造は、コンパイラとしての機能（Frontend, HIR, MIR, Codegen）に分かれていますが、ツール開発の観点では以下の課題があります：

- **情報の欠落**: 現在のLexer/Parserは空白やコメント（Trivia）を破棄するため、フォーマッタが実装できません。
- **結合度**: パーサーや診断システムが `cm` コンパイラ本体に密結合しており、他のツールからライブラリとして利用しにくい状態です。
- **エラー耐性**: コンパイルエラーがあると解析が止まるため、IDE支援（LSP）に不向きです。

## 2. 提案アーキテクチャ：`libcm_core` の分離

コンパイラとツールの両方が利用する基盤を「コアライブラリ」として切り出します。

### フォルダ構成案
```text
src/
├── core/ (NEW: libcm_core)
│   ├── lexer/        # Trivia保持版Lexer
│   ├── parser/       # エラー許容版Parser
│   ├── ast/          # Trivia情報を持つAST
│   ├── diagnostics/  # 構造化された診断システム
│   └── source/       # ソースコード管理・SourceMap
├── compiler/ (現在の main.cpp や各パス)
│   ├── hir/
│   ├── mir/
│   └── codegen/
├── linter/ (NEW: cm-lint)
│   ├── rules/        # 個別の静的解析ルール
│   └── engine/       # AST巡回エンジン
└── formatter/ (NEW: cm-fmt)
    └── printer/      # AST+Triviaからの再構築ロジック
```

## 3. 各ツールの実装アプローチ

### 3.1 フォーマッタ（cm-fmt）
- **アプローチ**: **"Lossless Syntax Tree"** 方式。
- **詳細**:
    - 全てのトークンに `leading_trivia` と `trailing_trivia` を持たせる。
    - ASTノードは構成するトークンの全範囲を保持する。
    - 出力時は、ASTの構造に基づく「理想のスタイル」と、元のトリビアにある「ユーザーのコメント」をマージして出力する。

### 3.2 リンター（cm-lint）
- **アプローチ**: **"Visitor-based Rule Engine"**。
- **詳細**:
    - `LintRule` インターフェースを定義し、`visit_let_stmt` などのフックを持たせる。
    - `UnusedVariableRule` や `ConstSuggestionRule` などをプラグイン形式で追加可能にする。
    - ユーザーが特定の行でエラーを無視するための `// @cm-ignore` のようなコメント制御を `core/lexer` レベルでサポートする。

### 3.3 言語サーバ（cm-lsp）
- **アプローチ**: `libcm_core` をラップしたLSPプロトコル実装。
- **詳細**:
    - エラーがあっても壊れない「インクリメンタル・パース」をサポート。
    - シンボルテーブルをキャッシュし、定義ジャンプや補完を高速化。

## 4. エラースキップと制御の仕組み

ツールやコンパイル時に特定のエラーを無視するための仕組みを導入します。

1.  **アトリビュートによる制御**:
    ```cm
    @[allow(unused_variable)]
    int x = 10;
    ```
2.  **コメントによる制御**:
    ```cm
    int y = 20; // cm-lint-disable-line no-magic-numbers
    ```

## 5. 移行ロードマップ

1.  **短期 (v0.11.0)**: 診断システム (`diagnostics`) を `src/common` から `src/core` へリファクタリングし、パーサーのエラーリカバリを強化。
2.  **中期 (v0.12.0)**: LexerをTrivia保持型に変更し、基本的なフォーマッタのプロトタイプを作成。
3.  **長期 (v0.13.0)**: 独立したリンターエンジンと、VSCode拡張機能向けのLSPをリリース。

---

この構成により、単なるコンパイラから「開発エコシステム」へとCm言語を拡張することが可能になります。
