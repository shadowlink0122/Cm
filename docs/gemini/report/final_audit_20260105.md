# Cmコンパイラ＆標準ライブラリ 最終監査報告書

**日付**: 2026年1月5日
**作成者**: Gemini Agent
**対象**: Cm プロジェクト全体

## 1. エグゼクティブサマリー

Cmプロジェクトは、C++の親しみやすさとRustの安全性を目指した現代的なシステムプログラミング言語として、強固な基礎を築いています。v0.10.0において、ジェネリクス、単相化（Monomorphization）、Union型、高度なモジュール構文などの主要機能が実装済みまたはプロトタイプとして機能しています。しかし、「実用的な開発ツール」としての完成度には、バックエンドのABI互換性、デバッグ情報、メモリ管理の自動化、および標準ライブラリの拡充において重大な課題が残されています。

## 2. コンパイラ基盤の課題 (Backend & Core)

### 2.1 ABI互換性の不備 (Critical)
- **現状**: 全ての構造体がポインタ渡しされており、値渡しを期待する標準Cライブラリ（FFI）との連携時にクラッシュやデータ破損が発生します。
- **解決策**: ターゲットプラットフォームのABI（System V, ARM64等）に従い、レジスタ渡しや `byval` 属性を適切に利用する実装が v0.11.0 で必須です。

### 2.2 デバッグ情報の欠如
- **現状**: `DIBuilder` の定義はあるが、実装が空です。
- **影響**: DWARF情報が出力されず、デバッガによるステップ実行や変数確認が不可能です。

### 2.3 メモリ管理とリソースリーク
- **現状**: 動的スライス (`cm_slice_new`) やファイル/標準入力から返される `string` が自動解放されません。
- **解決策**: デストラクタの自動生成、あるいは参照カウンタ/所有権システムの導入が必要です。

### 2.4 安全性の欠如
- **現状**: 配列アクセス時の境界チェックが未実装です。
- **影響**: 未定義動作 (UB) による脆弱性の原因となります。

## 3. 型システムとアルゴリズムの不備

### 3.1 型推論の単純さ
- **現状**: 「早い者勝ち」の局所的推論であり、複雑なジェネリクスの整合性チェックが不十分です。
- **提案**: Hindley-Milnerベースの単一化 (Unification) アルゴリズムへの刷新。

### 3.2 型チェッカーの無限再帰バグ
- **現状**: 相互参照する型定義（例: `type A = *B; type B = *A;`）の互換性チェックでスタックオーバーフローが発生します。
- **修正**: 巡回訪問チェック（Visited set）の導入が必要です。

### 3.3 最適化パスの高度化
- **現状**: 基本的なDCEや定数畳み込みはありますが、構造体を分解する **SROA** や **SSA形式** への変換が未実装です。
- **影響**: 高度なCSEやLICMの実装が困難になっています。

## 4. 標準ライブラリ (std/) の現状と欠落

### 4.1 実装済みモジュール
- `std::core`: 基本型エイリアス、`min/max/clamp`
- `std::io`: `print/println`、標準入力（メモリリークあり）
- `std::math`: Cライブラリラッパー + 整数論関数
- `std::mem`: `Allocator` インターフェース、`malloc` ベースの実装
- `std::fs`: 基本的なファイルI/O
- `std::iter`: `Range` 構造体

### 4.2 決定的な欠落要素
- **基本コレクション**: `Vector<T>`, `HashMap<K, V>`, `String` (動的ビルダ) が存在しません。
- **エラー処理**: `Result<T, E>` や `Option<T>` 型がなく、エラー時に空値を返すなどの不安定な実装になっています。
- **時刻/日付**: 時間計測や日付操作のモジュールがありません。
- **並行性**: スレッドや同期プリミティブが一切ありません。

## 5. ツール拡張 (Tooling) へのロードマップ

### 5.1 フォーマッタ (cm fmt)
- **課題**: 現在のLexerが空白・コメント（Trivia）を破棄しています。
- **解決策**: **Trivia付きToken** への移行と、Lossless Syntax Tree (LST) の構築が必要です。

### 5.2 リンター (cm lint)
- **提案**: `@[allow(...)]` アトリビュートと、エラーがあっても解析を止めない **エラー許容パーサ (Error Nodes)** の導入。

## 6. 次のステップ：v0.11.0 以降の優先順位

1.  **ABI互換性とメモリリーク修正 (最高)**: 実用的なFFIと、リークのないスライス操作を実現する。
2.  **型チェッカーの堅牢化 (高)**: 無限再帰の修正と、Unificationアルゴリズムの導入。
3.  **標準ライブラリの基盤構築 (中)**: `Result`, `Option`, `Vector` の実装。
4.  **ツール基盤の整備 (中)**: Trivia保持Lexerの実装。

---

Cm言語は非常にポテンシャルの高い設計を持っています。上記の基盤的欠陥を解消することで、言語のプロトタイプから、実用的なシステムプログラミング言語へと昇華できると確信しています。

**最終更新**: 2026年1月5日
**著者**: Gemini Agent
