[English](001_compiler_sufficiency_analysis_20260105.en.html)

# コンパイラ実装の網羅的健全性調査レポート (改訂版)

**日付**: 2026年1月5日
**作成者**: Gemini Agent
**対象**: Cm プロジェクト全体

## 1. 概要

本プロジェクトは、プログラミング言語コンパイラとしての基本的な構造（パーサー、型チェック、中間表現、コード生成）を備えていますが、**「実用的な開発ツール」**として見た場合、いくつかの決定的な機能欠落（Critical Gaps）と品質上の課題（Quality Issues）が存在します。

特に、デバッグ情報の生成欠落とABI互換性の問題は、外部ライブラリとの連携やデバッグ作業を著しく困難にする要因となります。

## 2. 重大な機能欠落 (Critical Gaps)

### 2.1 デバッグ情報の欠如 (Debug Info)
- **現状**: `src/codegen/llvm/core/context.hpp` に `llvm::DIBuilder` の定義はありますが、`src/codegen/llvm/core/context.cpp` や `mir_to_llvm.cpp` での初期化・使用コードが存在しません。
- **影響**: コンパイルされたバイナリには行番号や変数名などのDWARF情報が含まれません。`gdb` や `lldb` でステップ実行しても、ソースコードとの対応が取れず、実用的なデバッグが不可能です。

### 2.2 ABI互換性の不備 (FFI/ABI)
- **現状**: `src/codegen/llvm/core/mir_to_llvm.cpp` (`convertFunctionSignature`) において、構造体型の引数は一律にポインタ (`ctx.getPtrType()`) として渡されています。
- **影響**: C言語の標準的なABI（System V ABIなど）では、小さな構造体（例: `struct { int x, y; }`）はレジスタで値渡しされます。Cmコンパイラがポインタで渡してしまうと、既存のCライブラリ関数を呼び出した際にクラッシュやデータ破損が発生します。

### 2.3 ランタイムチェックの欠如 (Safety)
- **現状**: 配列アクセス時の境界チェック（Bounds Check）を生成するコードが `mir_to_llvm.cpp` に見当たりません。
- **影響**: 範囲外アクセスが発生した際、即座に安全に停止（パニック）せず、メモリ破壊やセキュリティ脆弱性につながる未定義動作（Undefined Behavior）を引き起こします。

### 2.4 メモリリーク (Resource Management)
- **現状**: `src/codegen/llvm/core/mir_to_llvm.cpp` で動的配列（スライス）生成時に `cm_slice_new` を呼び出していますが、生成されたスライスを解放する `cm_slice_free` などの呼び出しコードが生成されません。
- **影響**: スライスを作成するたびにメモリリークが発生し、長時間動作するプログラムではメモリ枯渇を引き起こします。

## 3. 品質の課題 (Quality Issues)

### 3.1 型チェッカーの無限再帰 (Stack Overflow)
- **現状**: `src/frontend/types/checking/utils.cpp` の `types_compatible` 関数は、再帰的な型定義（例: `type A = *B; type B = *A;`）に対して「訪問済み」チェックを行っていません。
- **影響**: 相互参照する型の互換性チェックを行うと、無限再帰によりコンパイラ自体がスタックオーバーフローでクラッシュします。

### 3.2 エラー報告システムの分断
- **現状**: `src/common/diagnostics.hpp` に共通の診断システムがある一方で、`src/frontend/parser/parser.hpp` などで独自のエラー構造体やリカバリロジックを持っています。
- **改善案**: 全てのエラー報告を `src/common/diagnostics` に統一し、構造化されたエラー出力を実現すべきです。

## 4. 推奨ロードマップ

以下の順序で改修を行うことを強く推奨します。

1.  **ABI互換性の修正 (High)**: 構造体の引数渡しを、ターゲットプラットフォームのABIに合わせる。
2.  **型チェッカーの修正 (High)**: `types_compatible` に再帰ガードを追加し、コンパイラのクラッシュを防ぐ。
3.  **デバッグ情報の生成 (High)**: `DIBuilder` を有効化し、行番号情報の出力を実装する。
4.  **ランタイムチェックの追加 (Medium)**: MIRまたはLLVM生成時に配列境界チェックを挿入する。
5.  **メモリ管理の確立 (Medium)**: スライスの寿命管理（デストラクタ呼び出し等）を実装する。

## 5. 結論

Cmコンパイラは言語としての体裁を整えつつありますが、バックエンドのABI対応、メモリ安全性、およびコンパイラ自体の堅牢性（無限再帰バグ）において重大な修正が必要です。これらは言語機能の拡張よりも優先されるべき課題です。