# 所有権と借用システム - 設計ドキュメント

## 概要

Cm言語はRust風の所有権・借用システムを採用しますが、**mutキーワードは使用しません**。
代わりに`const`キーワードで不変性を明示する方式を採用します。

## 基本原則

### 1. const-by-default（const優先）

変数が一度も変更されない場合、`const`を付けるべきです。
付いていない場合は**警告**（将来的にはエラー）となります。

```cm
// 良い例
const int x = 10;
const string name = "Alice";

// 変更される変数
int counter = 0;
counter = counter + 1;  // OK: counterは変更されるのでconstなし
```

### 2. 警告とエラー

| 状況 | 現在 | 将来 |
|------|------|------|
| 変更されない変数にconstなし | ⚠️ 警告 | ❌ エラー |
| const変数への再代入 | ❌ エラー | ❌ エラー |
| 未使用変数 | ⚠️ 警告 | ⚠️ 警告 |

### 3. 参照（借用）構文

Rustの`&`と`&mut`の代わりに、Cm言語では以下を使用：

| Rust | Cm | 説明 |
|------|-----|------|
| `&T` | `const T*` | 不変参照（読み取り専用借用） |
| `&mut T` | `T*` | 可変参照（変更可能借用） |

```cm
// 不変借用（読み取り専用）
void print_value(const int* p) {
    println("Value: {}", *p);
    // *p = 10;  // エラー: constポインタ経由で変更不可
}

// 可変借用（変更可能）
void increment(int* p) {
    *p = *p + 1;  // OK
}

int main() {
    int x = 10;
    print_value(&x);  // 不変借用
    increment(&x);    // 可変借用
    return 0;
}
```

## 借用ルール

### 同時借用の制限

```cm
int x = 10;

// ❌ エラー: 可変借用と不変借用の同時取得
int* p1 = &x;
const int* p2 = &x;  // p1が生存中は許可されない

// ❌ エラー: 複数の可変借用
int* p3 = &x;
int* p4 = &x;  // p3が生存中は許可されない

// ✅ OK: 複数の不変借用
const int* p5 = &x;
const int* p6 = &x;  // 両方とも読み取り専用なのでOK
```

### ライフタイム

借用のライフタイムはスコープに基づいて自動推論されます：

```cm
void example() {
    int owner = 10;
    {
        const int* borrow = &owner;  // 借用開始
        println("{}", *borrow);
    }  // 借用終了
    
    owner = 20;  // OK: 借用は終了している
}
```

## 実装計画

### Phase 1: 警告システム
- [ ] const推奨警告の追加
- [ ] 未使用変数警告の追加

### Phase 2: 借用チェッカー基礎
- [ ] `const T*` と `T*` の区別
- [ ] const経由での変更禁止

### Phase 3: 高度な借用チェック
- [ ] 二重可変借用の検出
- [ ] 可変/不変同時借用の検出
- [ ] ライフタイム推論

## Rustとの違い

| 概念 | Rust | Cm |
|------|------|-----|
| 可変性キーワード | `mut` | なし（デフォルト可変） |
| 不変性キーワード | なし（デフォルト不変） | `const` |
| 不変参照 | `&T` | `const T*` |
| 可変参照 | `&mut T` | `T*` |
| ムーブセマンティクス | デフォルト | `move`キーワード |

## 関連ドキュメント

- [リファクタリング提案](refactoring_proposal.md) - データフロー解析ベースの借用チェッカー
- [型システム](type_system.md) - 型チェックの詳細

---

*作成: 2026-01-05*
