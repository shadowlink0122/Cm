# LLVM最適化時のインポート無限ループ問題

## 問題の概要

日時: 2026-01-02
報告者: ユーザー
調査者: Claude

### 症状
- プログラムに`import`文が含まれている場合、O1-O3最適化でコンパイルが無限ループに陥る
- コンパイラ自体がハングし、タイムアウトしても終了しない
- macOSでプロセスステータスが"UE+"（uninterruptible I/O + trying to exit）になる

## 現象の詳細

### 動作する場合
- O0（最適化なし）: すべてのテストが正常動作
- O3でインポートなし: 単純なプログラムは正常にコンパイル・実行

### 失敗する場合
- O1-O3でインポートあり: コンパイラが無限ループ
- 特に`std::mem`などの標準ライブラリインポート時に顕著

## テスト結果

### 具体例: allocator_interface.cm
```cm
import std::mem::{malloc, free};

int main() {
    void* raw = malloc(sizeof(int));
    // ...
}
```

- O0: ✅ コンパイル成功、実行成功
- O1: ❌ コンパイルが終了しない（10秒以上タイムアウト後も継続）
- O2: ❌ コンパイルが終了しない
- O3: ❌ コンパイルが終了しない

## 技術的詳細

### 推測される原因
1. **インポートされた関数のLLVM IR生成時の問題**
   - インライン展開時の循環参照
   - 最適化パス内での無限ループ

2. **モジュールリンク時の問題**
   - 外部関数の解決処理で無限ループ
   - LLVMモジュール間の依存関係処理の不具合

## 一時的な対処

### デフォルト最適化レベルの変更
`src/main.cpp`:
```cpp
// 変更前
int optimization_level = 3;  // デフォルトO3最適化

// 変更後（一時的）
int optimization_level = 0;  // TODO: O1-O3でインポート時に無限ループ問題があるため一時的にO0
```

### ユーザーへの影響
- パフォーマンス: 最適化なしのため実行速度が低下
- 機能性: すべてのテストは正常に動作

## 今後の対応

### 必要な修正
1. **LLVM IR生成の見直し**
   - インポートされた関数の処理方法を修正
   - 最適化パス適用前の事前チェック追加

2. **デバッグとテスト**
   - LLVMデバッグビルドでの詳細な調査
   - 最適化パスごとの問題特定

3. **根本的な解決**
   - モジュールシステムの再設計
   - LLVM最適化パスとの互換性確保

## 関連ファイル
- `/src/codegen/llvm/core/mir_to_llvm.cpp` - MIRからLLVM IRへの変換
- `/src/codegen/llvm/native/codegen.hpp` - LLVM最適化パス適用
- `/src/main.cpp` - 最適化レベル設定

## 参考情報
- LLVM 14+ opaque pointer対応は別途実施済み
- インタプリタは最適化に関係なく完璧に動作
- JavaScriptバックエンドも独自実装のため影響なし