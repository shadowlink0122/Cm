---
title: v0.14.1
parent: Release Notes
nav_order: 1
---

# Cm v0.14.1 リリースノート

**リリース日:** 2026-02-19

## ✨ ハイライト

v0.14.1は**UEFIコンパイラバグ17件の修正**、**typedef算術演算サポート**、**GCC/Linux CIビルド修正**を含むパッチリリースです。CosmOS UEFI開発で発見されたコンパイラバグを全件修正し、MIR最適化パスのASM対応、naked関数コード生成の根本修正など広範な安定化を実施しました。

---

## 🐛 UEFIコンパイラバグ全件修正（Bug#1〜#17）

CosmOS UEFI開発中に発見されたコンパイラバグ17件を全て修正しました。

| Bug# | 問題 | 修正内容 | 修正ファイル |
|------|------|----------|------------|
| #1 | char switchの符号拡張 | switch_intのchar型比較を修正 | `mir_to_llvm.cpp` |
| #5 | LICM最適化がASM出力変数を移動 | ASM出力変数をループ不変と誤判定しない修正 | `licm.cpp` |
| #6 | constant foldingのASM出力追跡 | ASM→変数代入チェーンの最適化を抑制 | `folding.cpp` |
| #7 | `utiny*`デリファレンスのi32切り詰め | ポインタデリファレンスの型幅修正 | `mir_to_llvm.cpp` |
| #8 | `int→utiny`キャストの符号拡張 | trunc命令の正しい適用 | `mir_to_llvm.cpp` |
| #9 | 構造体フィールドの定数畳み込み | フィールドアクセスの最適化を抑制 | `folding.cpp` |
| #10 | `ptr->method()`のself書き戻し | MIR loweringでポインタ経由の書き戻し実装 | `stmt.cpp` (MIR) |
| #11 | UEFIレジスタマッピング不正 | x86_64 UEFI ABIに合わせたレジスタリマップ | `mir_to_llvm.cpp` |
| #12 | naked関数のプロローグ/エピローグ干渉 | Naked+$N事前置換方式に統一 | `mir_to_llvm.cpp` |
| #13 | LLVM最適化によるcall/ret消滅 | UEFIターゲットの最適化レベル調整 | `codegen.cpp` (native) |
| #14 | 構造体配列の全体再代入でゴミ値 | memcpy/配列代入の型サイズ修正 | `mir_to_llvm.cpp` |
| #15 | 非export関数がexport関数から呼出不可 | シンボル解決の修正 | `import.cpp` |
| #16 | `&local as ulong`キャスト不正 | ポインタ→整数キャストの修正 | `mir_to_llvm.cpp` |
| #17 | UEFIスタックプローブクラッシュ | スタックプローブの無効化 | `codegen.cpp` (native) |

---

## 🔧 言語機能の修正

### typedef算術演算サポート

typedef型の値に対する算術演算・比較演算が正常に動作するようになりました。

```cm
typedef EFI_STATUS = ulong;
EFI_STATUS status = 0;
if (status != 0) { /* 修正前: コンパイルエラー → 修正後: 正常動作 */ }
```

| 問題 | 修正ファイル |
|------|------------|
| typedef型のis_numeric判定漏れ | `checking/expr.cpp` |
| typedef引数のstatic→static呼び出し時の型解決 | `monomorphization_impl.cpp` |

### 整数型出力の完全対応

MIR loweringのprintln関数選択ロジックにlong/ulong/uint/isize/usize型のケースを追加。i32範囲を超える値が正しく出力されるようになりました。

```cm
long v = 0x80000000;  // 2147483648
println(v);           // 修正前: -2147483648 (i32切り詰め)
                      // 修正後: 2147483648 (正しい出力)
```

---

## 🏗️ バックエンド改善

### GCC/Linux CIビルド修正

`src/mir/nodes.hpp`に`<unordered_map>`ヘッダーを追加。AppleClangでは間接インクルードで解決されていたが、GCCでは明示的なインクルードが必要でした。

### JS/WASMランタイム改善

| ファイル | 変更内容 |
|---------|----------|
| `src/codegen/js/builtins.cpp` | `cm_println_long`/`ulong`/`uint`とformat/to_string版追加 |
| `src/codegen/llvm/wasm/runtime_print.c` | `cm_println_long`/`ulong`出力関数追加 |
| `src/codegen/llvm/core/operators.cpp` | ビット演算（BitAnd/BitOr/BitXor）の型幅統一ロジック追加 |
| `src/mir/passes/interprocedural/inlining.cpp` | ASM含有関数のインライン展開禁止 |

### MIR最適化パスのASM対応

| パス | 修正内容 |
|------|----------|
| LICM (Loop Invariant Code Motion) | ASM出力変数をループ不変と誤判定しない修正 |
| Constant Folding | ASM→変数代入チェーンの最適化を抑制 |
| Constant Folding | 構造体フィールドアクセスの最適化を抑制 |
| Inlining | ASM含有関数のインライン展開を禁止 |

---

## 📁 主要な変更ファイル

| ファイル | 変更内容 |
|---------|----------|
| `src/codegen/llvm/core/mir_to_llvm.cpp` | Bug#1/7/8/11/12/14/16修正、naked関数統一 |
| `src/codegen/llvm/native/codegen.cpp` | Bug#13/17: UEFI最適化レベル調整、スタックプローブ無効化 |
| `src/mir/lowering/expr_call.cpp` | println型選択にlong/ulong/uint/isize/usize追加 |
| `src/mir/lowering/stmt.cpp` | Bug#10: ptr->method()のself書き戻し |
| `src/mir/lowering/monomorphization_impl.cpp` | typedef引数の型解決修正 |
| `src/mir/passes/scalar/folding.cpp` | Bug#6/9: ASM出力・構造体フィールド最適化抑制 |
| `src/mir/passes/loop/licm.cpp` | Bug#5: ASM出力変数のループ不変判定修正 |
| `src/mir/nodes.hpp` | GCC CIビルド修正（unordered_mapヘッダー追加） |
| `src/frontend/types/checking/expr.cpp` | typedef算術演算サポート |
| `src/preprocessor/import.cpp` | Bug#15: 非export関数のシンボル解決修正 |

---

## 🧪 テスト状況

| バックエンド | 通過 | 失敗 | スキップ |
|------------|------|------|---------|
| JIT (O0) | 347 | 0 | 4 |
| LLVM Native | 380 | 0 | 7 |
| LLVM WASM | 346 | 0 | 5 |
| JavaScript | 306 | 0 | 49 |
| Baremetal | 11 | 0 | 0 |
| UEFI | 5+ | 0 | 0 |

---

## 📊 統計

- **テスト総数**: 351+
- **JIT通過**: 347（0失敗）
- **LLVM通過**: 380（0失敗）
- **WASM通過**: 346（0失敗）
- **JS通過**: 306（0失敗）
- **UEFIコンパイルテスト**: 5+（全バグ回帰テスト含む）

---

## 🔮 今後の予定

- **v0.15.0**: File I/O、パッケージ管理、JSバックエンドのポインタ/VTable対応、UEFI/ベアメタルの拡充
