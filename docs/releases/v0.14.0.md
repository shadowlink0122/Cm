---
title: v0.14.0
parent: Release Notes
nav_order: 1
---

# Cm v0.14.0 リリースノート

**リリース日:** 2026-02-10

## ✨ ハイライト

v0.14.0は、**JavaScriptバックエンドの大規模改善**、**演算子オーバーロードの設計改善**、**ベアメタル/UEFIサポート**、**インラインユニオン型 (`int | null`) の実装**、**プラットフォームディレクティブの導入**を含むリリースです。JSバックエンドのテスト通過率が55%から85%に向上し、演算子オーバーロードでは`impl T`構文と複合代入演算子(`+=`等)をサポートしました。また、UEFIターゲットでのベアメタル開発が可能になりました。

### 主要な変更点

- **JSバックエンド大規模リファクタリング**: codegen.cppから1,600行以上を削り、モジュール分割でコード品質を向上
- **JSテスト通過率向上**: 55% → 85%（206/372 → 293/344）
- **演算子オーバーロード改善**: `impl T { operator ... }` 構文で直接演算子定義が可能に
- **複合代入演算子**: `+=`, `-=`, `*=`, `/=`, `%=`, `&=`, `|=`, `^=`, `<<=`, `>>=` をサポート
- **ビット演算子オーバーロード**: `&`, `|`, `^`, `<<`, `>>` のカスタム定義に対応
- **インラインユニオン型**: `int | null` のようなインラインユニオン構文を導入
- **null型**: 独立した`null`型を追加（`TypeKind::Null`）
- **プラットフォームディレクティブ**: `//! platform:` でファイルレベルの実行環境制約を指定
- **ベアメタル/UEFIサポート**: `--target=uefi`でUEFI Hello Worldが動作、QEMUで出力確認済み
- **インラインASM自動クロバー検出**: ハードコードレジスタの自動検出でインライン展開時のバグを防止
- **Enum Associated Data修正**: 文字列・構造体ペイロードの`println`出力が正常に動作
- **Tagged Union構造体ペイロードサイズ修正**: 3フィールド以上の構造体ペイロードの破損を修正
- **interface存在チェック**: `impl T for I` の `I` が宣言済みinterfaceであることを検証

---

## 🚀 JSバックエンド改善

### codegen.cppの大規模リファクタリング

JSコードジェネレータを大幅にリファクタリングし、コードの保守性と品質を向上させました。

| 変更 | 詳細 |
|------|------|
| codegen.cpp | -1,618行（不要なコード削除・整理） |
| emit_expressions.cpp | +124行（式の出力改善） |
| emit_statements.cpp | +80行（文の出力改善） |
| builtins.hpp | +71行（ビルトイン関数マッピング拡充） |
| runtime.hpp | +19行（ランタイムヘルパー追加） |
| types.hpp | +9行（型マッピング改善） |

### JSテスト通過率

| バージョン | パス | 失敗 | スキップ | 通過率 |
|-----------|------|------|---------|--------|
| v0.13.1 | 206 | 119 | 47 | 55% |
| **v0.14.0** | **293** | **1** | **50** | **85%** |

**失敗テスト: 119 → 1**（未対応テストは適切にスキップに移行）

### JSコンパイルの使い方

```bash
# JSへコンパイル
./cm compile --target=js hello.cm -o output.js

# 実行
node output.js
```

詳細は [JSコンパイルチュートリアル](../tutorials/ja/compiler/js-compilation.md) を参照してください。

---

## 🐛 バグ修正

### Enum Associated Dataのprintln出力修正

match armのペイロード変数を`println`で出力する際、ランタイムハングや不正な出力が発生するバグを修正しました。

```cm
enum Message {
    Quit,
    Write(string)
}

int main() {
    Message m = Message::Write("Hello");
    match (m) {
        Message::Write(t) => {
            println(t);  // v0.13.1: ハング → v0.14.0: "Hello"
        }
        _ => {}
    }
    return 0;
}
```

| 問題 | 原因 | 修正ファイル |
|-----|------|------------|
| println型判定の誤り | AST型チェッカーがmatch armのpayload変数の型を`int`に設定 | `expr_call.cpp` |
| ペイロードロードエラー | Tagged Unionの非構造体ペイロードの型が`i32`にハードコード | `mir_to_llvm.cpp` |

### Tagged Union構造体ペイロードのサイズ修正

3フィールド以上の構造体をenumペイロードに格納すると、3番目以降のフィールドが破損するバグを修正しました。

```cm
struct RGB {
    int r;
    int g;
    int b;
}

enum Color {
    None,
    Set(RGB)
}

int main() {
    Color c = Color::Set(RGB { r: 255, g: 128, b: 0 });
    match (c) {
        Color::Set(v) => {
            println("RGB({v.r}, {v.g}, {v.b})");
            // v0.13.1: RGB(255, 128, 1) ← b=0が1に破損
            // v0.14.0: RGB(255, 128, 0) ← 正常
        }
        _ => {}
    }
    return 0;
}
```

| 問題 | 原因 | 修正ファイル |
|-----|------|------------|
| 構造体3番目以降のフィールドが破損 | `max_payload_size()`がStruct型をデフォルト8バイトで計算 | `types.cpp` |

**修正**: LLVM DataLayoutを使用して構造体型のサイズを正確に計算するよう変更。

---

## 🎼 演算子オーバーロード改善

### `impl T { operator ... }` 構文

演算子を `impl T for InterfaceName` ではなく、直接 `impl T { operator ... }` で定義可能になりました。

```cm
struct Vec2 {
    int x;
    int y;
}

impl Vec2 {
    operator Vec2 +(Vec2 other) {
        return Vec2{x: self.x + other.x, y: self.y + other.y};
    }

    operator Vec2 -(Vec2 other) {
        return Vec2{x: self.x - other.x, y: self.y - other.y};
    }
}
```

### 複合代入演算子

二項演算子を定義すると、対応する複合代入演算子（`+=`, `-=`, `*=`, `/=`, `%=`, `&=`, `|=`, `^=`, `<<=`, `>>=`）が自動的に使えます。

```cm
int main() {
    Vec2 v = Vec2{x: 10, y: 20};
    v += Vec2{x: 5, y: 3};   // Vec2{15, 23}
    v -= Vec2{x: 2, y: 1};   // Vec2{13, 22}
    return 0;
}
```

### ビット演算子オーバーロード

`&`, `|`, `^`, `<<`, `>>` の全ビット演算子をオーバーロード可能になりました。

### interface存在チェック

`impl T for I` 構文で `I` が宣言済みinterfaceでない場合、コンパイルエラーになります。これにより、マジックストリング（`impl T for Add` 等）によるバグを防止します。

---

## 🧬 インラインユニオン型とnull型

### インラインユニオン構文 (`int | null`)

インラインユニオン構文（`|`）でnull許容型を表現できるようになりました。

```cm
import std::io::println;

// typedefのユニオン型は従来通り
typedef MaybeInt = int | null;

// インラインユニオン型: typedefなしで直接型を結合
int main() {
    int | null a = null;           // nullが代入可能
    int | null b = 42 as MaybeInt; // int値も代入可能
    int | string | null c = null;  // 3型以上のユニオンも可能
    return 0;
}
```

| 変更 | 詳細 |
|------|------|
| `null`型追加 | `TypeKind::Null`、`make_null()` |
| `parse_type_with_union()` | 変数宣言・関数戻り値・構造体フィールドで使用 |
| 型互換性 | Unionメンバー型とのnull代入・値代入に対応 |

> **注意:** operator戻り値型では `|` がビットOR演算子と競合するため、インラインユニオンは使用できません。`typedef`を使用してください。

---

## 🌍 プラットフォームディレクティブ

ファイル先頭に `//! platform:` ディレクティブを記述することで、そのファイルが実行可能なプラットフォームを制約できます。

```cm
//! platform: native
// このファイルはLLVM Native/JITでのみコンパイル可能

import std::io::println;
int main() {
    println("Native only");
    return 0;
}
```

対応プラットフォーム: `native`, `js`, `wasm`, `uefi`, `baremetal`

---

## 🔧 ビルド・テスト改善

### JSスキップファイルの整理

JSバックエンドで未サポートのネイティブAPI機能カテゴリに`.skip`ファイルを追加:

| カテゴリ | 理由 |
|---------|------|
| `asm/` | インラインアセンブリはJS非対応 |
| `io/` | ファイルI/OはJS非対応 |
| `net/` | TCP/HTTPソケットはJS非対応 |
| `sync/` | Mutex/Channel/AtomicはJS非対応 |
| `thread/` | スレッドはJS非対応 |

### reimportテストの修正

`advanced_modules/reimport.cm`テストの出力を修正し、NativeとJSの両方で正しい結果を出力するようにしました。

---

## 🖥️ ベアメタル / UEFI サポート

### UEFI Hello World

`--target=uefi` オプションでUEFIアプリケーションをコンパイルできるようになりました。OSなし（no_std）のベアメタル環境で動作し、QEMU + OVMFで「Hello World from Cm!」の出力を確認しています。

```bash
# UEFIアプリケーションのビルド
cm compile --target=uefi -o hello.o hello_world.cm
lld-link /subsystem:efi_application /entry:efi_main /out:BOOTX64.EFI hello.o

# QEMUで実行
qemu-system-x86_64 -drive if=pflash,format=raw,readonly=on,file=OVMF.fd \
    -drive format=raw,file=fat:rw:esp -net none -nographic
```

```cm
// UEFI Hello World
import ./libs/efi_core;
import ./libs/efi_text;

ulong efi_main(void* image_handle, void* system_table) {
    efi_clear_screen(system_table);
    string msg = "Hello World from Cm!";
    efi_println(system_table, msg as void*);
    while (true) { __asm__("hlt"); }
    return 0;
}
```

### インラインASM自動クロバー検出

インラインアセンブリ内のハードコードレジスタ（`%rax`, `%rcx`, `%rdi`等）を自動検出し、LLVMクロバーリストに追加する機能を実装しました。これにより、インライン展開時にLLVMがASMで破壊されたレジスタの値を再利用するバグを防止します。

| 問題 | 原因 | 修正 |
|-----|------|------|
| UEFI出力なし | ASMのハードコードレジスタがクロバー未宣言 | `mir_to_llvm.cpp`: 自動クロバー検出 |
| #GPクラッシュ | LLVMレジスタ割当とハードコードの競合 | `efi_text.cm`: pushq/popqパターン |

---

## 📁 主要な変更ファイル

### JSバックエンド

| ファイル | 変更内容 |
|---------|---------| 
| `src/codegen/js/codegen.cpp` | 大規模リファクタリング（-1,618行） |
| `src/codegen/js/emit_expressions.cpp` | 式出力の改善 |
| `src/codegen/js/emit_statements.cpp` | 文出力の改善 |
| `src/codegen/js/builtins.hpp` | ビルトイン関数マッピング拡充 |
| `src/codegen/js/runtime.hpp` | ランタイムヘルパー追加 |
| `src/codegen/js/types.hpp` | 型マッピング改善 |
| `src/codegen/js/codegen.hpp` | ヘッダ追加 |

### LLVMバックエンド修正

| ファイル | 変更内容 |
|---------|---------|
| `src/codegen/llvm/core/types.cpp` | Tagged Unionペイロードサイズ計算修正 |
| `src/codegen/llvm/core/mir_to_llvm.cpp` | ペイロードロード修正、デバッグ出力削除 |

### MIR Lowering修正

| ファイル | 変更内容 |
|---------|---------|
| `src/mir/lowering/expr_call.cpp` | println型判定でMIRローカル型を優先 |
| `src/mir/lowering/impl.cpp` | impl lowering改善 |

### テスト

| ファイル | 変更内容 |
|---------|---------|
| `tests/test_programs/enum/associated_data.cm` | b=1テストケース更新 |
| `tests/test_programs/enum/associated_data.expected` | 新規（.error → .expected） |
| `tests/test_programs/asm/.skip` 等 | JSスキップファイル追加 |
| `tests/unified_test_runner.sh` | テストランナー改善 |

---

## 🧪 テスト状況

| バックエンド | 通過 | 失敗 | スキップ |
|------------|-----|------|---------|
| JIT (O0) | 368 | 0 | 8 |
| LLVM Native | 368 | 0 | 8 |
| JavaScript | 293 | 1 | 50 |

---

## 📊 統計

- **テスト総数**: 376
- **JIT/LLVMテスト通過**: 368（0失敗）
- **JSテスト通過**: 293（1失敗、v0.13.1の206から+87改善）
- **UEFIテスト**: QEMUでHello World出力確認済み
- **変更ファイル数**: 98+
- **追加行数**: +5,500+
- **削除行数**: -2,500+

---

## 🔮 今後の予定

- **v0.15.0**: File I/O、パッケージ管理、JSバックエンドのポインタ/VTable対応、UEFI/ベアメタルの拡充

---

## 📝 謝辞

このリリースは、JSバックエンドの品質大幅向上とNative/JS間の出力一致性確保という重要な目標を達成しました。
