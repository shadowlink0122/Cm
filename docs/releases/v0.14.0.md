---
title: v0.14.0
parent: Release Notes
nav_order: 1
---

# Cm v0.14.0 リリースノート

**リリース日:** 2026-02-10

## ✨ ハイライト

v0.14.0は、**JavaScriptバックエンドの大規模改善**、**Enumの関連データ(Associated Data)修正**、**Tagged Unionの構造体ペイロード修正**を含むリリースです。JSバックエンドのテスト通過率が55%から77%に向上し、NativeとJSの出力一致性が大幅に改善されました。

### 主要な変更点

- **JSバックエンド大規模リファクタリング**: codegen.cppから1,600行以上を削り、モジュール分割でコード品質を向上
- **JSテスト通過率向上**: 55% → 77%（206/372 → 285/372）
- **Enum Associated Data修正**: 文字列・構造体ペイロードの`println`出力が正常に動作
- **Tagged Union構造体ペイロードサイズ修正**: 3フィールド以上の構造体ペイロードの破損を修正
- **JSスキップファイル整理**: asm, io, net, sync, threadカテゴリをJSスキップ対象に追加

---

## 🚀 JSバックエンド改善

### codegen.cppの大規模リファクタリング

JSコードジェネレータを大幅にリファクタリングし、コードの保守性と品質を向上させました。

| 変更 | 詳細 |
|------|------|
| codegen.cpp | -1,618行（不要なコード削除・整理） |
| emit_expressions.cpp | +124行（式の出力改善） |
| emit_statements.cpp | +80行（文の出力改善） |
| builtins.hpp | +71行（ビルトイン関数マッピング拡充） |
| runtime.hpp | +19行（ランタイムヘルパー追加） |
| types.hpp | +9行（型マッピング改善） |

### JSテスト通過率

| バージョン | パス | 失敗 | スキップ | 通過率 |
|-----------|------|------|---------|--------|
| v0.13.1 | 206 | 119 | 47 | 55% |
| **v0.14.0** | **285** | **0** | **87** | **77%** |

**失敗テスト: 119 → 0**（未対応テストは適切にスキップに移行）

### JSコンパイルの使い方

```bash
# JSへコンパイル
./cm compile --target=js hello.cm -o output.js

# 実行
node output.js
```

詳細は [JSコンパイルチュートリアル](../tutorials/ja/compiler/js-compilation.md) を参照してください。

---

## 🐛 バグ修正

### Enum Associated Dataのprintln出力修正

match armのペイロード変数を`println`で出力する際、ランタイムハングや不正な出力が発生するバグを修正しました。

```cm
enum Message {
    Quit,
    Write(string)
}

int main() {
    Message m = Message::Write("Hello");
    match (m) {
        Message::Write(t) => {
            println(t);  // v0.13.1: ハング → v0.14.0: "Hello"
        }
        _ => {}
    }
    return 0;
}
```

| 問題 | 原因 | 修正ファイル |
|-----|------|------------|
| println型判定の誤り | AST型チェッカーがmatch armのpayload変数の型を`int`に設定 | `expr_call.cpp` |
| ペイロードロードエラー | Tagged Unionの非構造体ペイロードの型が`i32`にハードコード | `mir_to_llvm.cpp` |

### Tagged Union構造体ペイロードのサイズ修正

3フィールド以上の構造体をenumペイロードに格納すると、3番目以降のフィールドが破損するバグを修正しました。

```cm
struct RGB {
    int r;
    int g;
    int b;
}

enum Color {
    None,
    Set(RGB)
}

int main() {
    Color c = Color::Set(RGB { r: 255, g: 128, b: 0 });
    match (c) {
        Color::Set(v) => {
            println("RGB({v.r}, {v.g}, {v.b})");
            // v0.13.1: RGB(255, 128, 1) ← b=0が1に破損
            // v0.14.0: RGB(255, 128, 0) ← 正常
        }
        _ => {}
    }
    return 0;
}
```

| 問題 | 原因 | 修正ファイル |
|-----|------|------------|
| 構造体3番目以降のフィールドが破損 | `max_payload_size()`がStruct型をデフォルト8バイトで計算 | `types.cpp` |

**修正**: LLVM DataLayoutを使用して構造体型のサイズを正確に計算するよう変更。

---

## 🔧 ビルド・テスト改善

### JSスキップファイルの整理

JSバックエンドで未サポートのネイティブAPI機能カテゴリに`.skip`ファイルを追加:

| カテゴリ | 理由 |
|---------|------|
| `asm/` | インラインアセンブリはJS非対応 |
| `io/` | ファイルI/OはJS非対応 |
| `net/` | TCP/HTTPソケットはJS非対応 |
| `sync/` | Mutex/Channel/AtomicはJS非対応 |
| `thread/` | スレッドはJS非対応 |

### reimportテストの修正

`advanced_modules/reimport.cm`テストの出力を修正し、NativeとJSの両方で正しい結果を出力するようにしました。

---

## 📁 主要な変更ファイル

### JSバックエンド

| ファイル | 変更内容 |
|---------|---------| 
| `src/codegen/js/codegen.cpp` | 大規模リファクタリング（-1,618行） |
| `src/codegen/js/emit_expressions.cpp` | 式出力の改善 |
| `src/codegen/js/emit_statements.cpp` | 文出力の改善 |
| `src/codegen/js/builtins.hpp` | ビルトイン関数マッピング拡充 |
| `src/codegen/js/runtime.hpp` | ランタイムヘルパー追加 |
| `src/codegen/js/types.hpp` | 型マッピング改善 |
| `src/codegen/js/codegen.hpp` | ヘッダ追加 |

### LLVMバックエンド修正

| ファイル | 変更内容 |
|---------|---------|
| `src/codegen/llvm/core/types.cpp` | Tagged Unionペイロードサイズ計算修正 |
| `src/codegen/llvm/core/mir_to_llvm.cpp` | ペイロードロード修正、デバッグ出力削除 |

### MIR Lowering修正

| ファイル | 変更内容 |
|---------|---------|
| `src/mir/lowering/expr_call.cpp` | println型判定でMIRローカル型を優先 |
| `src/mir/lowering/impl.cpp` | impl lowering改善 |

### テスト

| ファイル | 変更内容 |
|---------|---------|
| `tests/test_programs/enum/associated_data.cm` | b=1テストケース更新 |
| `tests/test_programs/enum/associated_data.expected` | 新規（.error → .expected） |
| `tests/test_programs/asm/.skip` 等 | JSスキップファイル追加 |
| `tests/unified_test_runner.sh` | テストランナー改善 |

---

## 🧪 テスト状況

| バックエンド | 通過 | 失敗 | スキップ |
|------------|-----|------|---------|
| JIT (O0) | 363 | 0 | 9 |
| JavaScript | 285 | 0 | 87 |

---

## 📊 統計

- **テスト総数**: 372
- **JITテスト通過**: 363（0失敗）
- **JSテスト通過**: 285（0失敗、v0.13.1の206から+79改善）
- **変更ファイル数**: 27
- **追加行数**: +468
- **削除行数**: -1,708

---

## 🔮 今後の予定

- **v0.15.0**: File I/O、パッケージ管理、JSバックエンドのポインタ/VTable対応

---

## 📝 謝辞

このリリースは、JSバックエンドの品質大幅向上とNative/JS間の出力一致性確保という重要な目標を達成しました。
