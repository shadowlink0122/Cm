# モジュールシステム実装状況（2024-12-20）

## 📋 現在の状況

### ✅ 完了した準備作業

1. **設計文書の完成**
   - `docs/design/MODULE_SYSTEM_FINAL.md` v5.0
   - 完全な仕様、3つの実装パターン、エラー処理

2. **実装計画の作成**
   - `docs/design/MODULE_IMPLEMENTATION_PLAN.md`
   - 4ステップの詳細な実装計画
   - リスク分析と対策

3. **既存実装の分析**
   - ASTとパーサーの基本構造は存在
   - 不足している機能を特定
   - テストケースの準備完了

### 📊 既存実装の評価

#### ✅ 実装済み
- `ModulePath`, `ImportDecl`, `ExportDecl` のAST
- `module M;` 宣言のパース
- `import path::to::module;` のパース
- `export fn foo() {}` のパース（宣言の直接エクスポート）

#### 🔄 部分実装
- `export { M };` 構文（パースは可能だが処理未完成）
- `import path::*;` ワイルドカード（パースのみ）
- `import path::{item};` 選択的インポート（パースのみ）

#### ❌ 未実装
- 相対パス（`./`, `../`）のサポート
- 式中の`::`演算子の処理（`std::io::println`）
- プリプロセッサでの再エクスポート処理
- 階層的インポートの解決（`import std::io;`）
- `namespace` の自動生成
- ディレクトリベースのモジュール解決

## 🎯 実装計画（Phase 1）

### ステップ1: パーサーの拡張（4日）
**優先度**: 🔴 高

**タスク**:
1. 相対パスのトークン処理
   - `./` と `../` の認識
   - パス区切り文字（`/`）の処理

2. `export { M };` 構文の完全実装
   - 複数モジュールの再エクスポート
   - エイリアス付きエクスポート

3. 式中の`::`演算子の修正
   - `std::io::println()` が正しくパースされるように
   - 名前空間付き関数呼び出しのサポート

**ファイル**:
- `src/frontend/parser/parser_module.cpp`
- `src/frontend/parser/parser_expr.cpp`

---

### ステップ2: モジュール解決の強化（4日）
**優先度**: 🔴 高

**タスク**:
1. ディレクトリ探索ロジック
   - `import ./io;` → `io/io.cm` または `io/mod.cm` を探す
   - 優先順位の実装

2. 相対パス解決
   - 現在のファイルからの相対位置計算
   - `../` による親ディレクトリへの移動

3. 深い階層のサポート
   - `import ./io/file;` → `io/file/file.cm` を探す

**ファイル**:
- `src/module/module_resolver.cpp`
- `src/module/module_resolver.hpp`

---

### ステップ3: プリプロセッサの拡張（6日）
**優先度**: 🔴 高

**タスク**:
1. 再エクスポートの検出
   - `export { io };` を発見
   - エクスポートリストの管理

2. 階層的インポートの解決
   - `import std::io;` → std.cm → io.cm の追跡
   - 再エクスポートチェーンの辿り

3. `namespace` の生成
   - `namespace std { namespace io { ... } }` の自動生成
   - ネストした名前空間の処理

**ファイル**:
- `src/preprocessor/import_preprocessor.cpp`
- `src/preprocessor/import_preprocessor.hpp`

---

### ステップ4: テストとドキュメント（4日）
**優先度**: 🟡 中

**タスク**:
1. テストケースの作成
   - 基本的な再エクスポート
   - 深い階層のインポート
   - エラーケース

2. 統合テストの実行
   - 既存機能の非破壊確認
   - パフォーマンステスト

3. ドキュメントの更新
   - ユーザーガイド
   - APIリファレンス
   - サンプルコード

**ファイル**:
- `tests/test_programs/modules/`
- `docs/user_guide/modules.md`

## 📝 現在の問題点

### 問題1: 式中の`::`演算子
**現象**: `std::io::println()` がパースエラー

**原因**: パーサーが`::`を演算子として認識していない可能性

**解決策**: 
- `parser_expr.cpp` で`::`をメンバーアクセス演算子として処理
- または名前空間修飾子として特別扱い

### 問題2: 相対パスのトークン化
**現象**: `./` がトークン化されない

**原因**: レキサーが`.`と`/`を別々のトークンとして扱う

**解決策**:
- パーサーで`.` + `/` のシーケンスを認識
- または特別なトークン`RelativePath`を追加

### 問題3: プリプロセッサの複雑性
**現象**: 既存のプリプロセッサが基本的な機能のみ

**原因**: 再エクスポートの追跡機能がない

**解決策**:
- モジュール情報の管理データ構造を追加
- エクスポートマップの実装

## 🚀 次のアクション

### 今すぐ開始できること
1. **テストケースの完成**
   - 期待される動作を明確化
   - テスト駆動開発の準備

2. **パーサーのデバッグ**
   - `::`演算子の問題を調査
   - 既存のパース機能の確認

3. **プロトタイプの作成**
   - シンプルなケースで動作確認
   - 段階的な機能追加

### 長期タスク
1. **Phase 2の準備**
   - 階層再構築（`export { io::{file} }`）
   - より複雑なパターンのサポート

2. **Phase 3の計画**
   - ワイルドカード自動検出
   - 大規模プロジェクトでのテスト

## 📊 推定スケジュール

| Week | タスク | 状態 |
|------|--------|------|
| 1 | パーサー拡張 | ⬜ 未着手 |
| 2 | モジュール解決 | ⬜ 未着手 |
| 3 | プリプロセッサ拡張 | ⬜ 未着手 |
| 4 | テストと統合 | ⬜ 未着手 |

**完了予定**: 2025年1月中旬

## 📚 参考資料

- **設計**: `docs/design/MODULE_SYSTEM_FINAL.md`
- **実装計画**: `docs/design/MODULE_IMPLEMENTATION_PLAN.md`
- **テスト**: `tests/test_programs/modules/`

---

**最終更新**: 2024年12月20日  
**ステータス**: 設計完了、実装準備完了  
**次回更新**: 実装開始時
